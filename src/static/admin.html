<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MelodAI Admin</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="icon" href="/logo.svg" />
    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #0ea5e9;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --background: #f8fafc;
        --surface: #ffffff;
        --text: #1e293b;
        --text-light: #64748b;
        --border: #e2e8f0;
        --hover: #f1f5f9;
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      }

      [data-theme='dark'] {
        --primary: #818cf8;
        --primary-dark: #6366f1;
        --secondary: #38bdf8;
        --success: #4ade80;
        --danger: #f87171;
        --warning: #fbbf24;
        --background: #0f172a;
        --surface: #1e293b;
        --text: #e2e8f0;
        --text-light: #cbd5e1;
        --border: #475569;
        --hover: #334155;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: var(--background);
        margin: 0;
        padding: 0;
        color: var(--text);
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--surface);
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      .header h1 {
        margin: 0;
        font-size: 1.875rem;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .header h1 i {
        font-size: 1.5rem;
      }

      .btn-container {
        display: flex;
        gap: 0.75rem;
      }

      button {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .theme-btn {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .theme-btn:hover {
        background: var(--hover);
      }

      .home-btn {
        background: var(--primary);
        color: white;
      }

      .home-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .logout-btn {
        background: var(--danger);
        color: white;
      }

      .logout-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .tab-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        background: var(--surface);
        padding: 0.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }

      .tab {
        padding: 0.75rem 1.5rem;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text-light);
        border-radius: 8px;
        transition: all 0.2s;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tab:hover {
        background: var(--hover);
        color: var(--text);
      }

      .tab.active {
        background: var(--primary);
        color: white;
      }

      .card {
        background: var(--surface);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
      }

      .card h2,
      .card h3 {
        margin: 0 0 1.5rem 0;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        padding: 1.5rem;
        border-radius: 12px;
        color: white;
        box-shadow: var(--shadow-lg);
        transition: transform 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-4px);
      }

      .stat-card i {
        font-size: 2rem;
        opacity: 0.8;
        margin-bottom: 0.75rem;
      }

      .stat-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        font-weight: 500;
        opacity: 0.9;
        color: white;
      }

      .stat-card p {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
        color: white;
      }

      .stat-card:nth-child(1) {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      }

      .stat-card:nth-child(2) {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      }

      .stat-card:nth-child(3) {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      }

      .stat-card:nth-child(4) {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }

      .stat-card:nth-child(5) {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      th {
        background: var(--hover);
        font-weight: 600;
        color: var(--text);
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      th:first-child {
        border-top-left-radius: 8px;
      }

      th:last-child {
        border-top-right-radius: 8px;
      }

      th:hover {
        background: var(--border);
      }

      tbody tr {
        transition: background 0.2s;
      }

      tbody tr:hover {
        background: var(--hover);
      }

      .sort-asc::after {
        content: ' ↑';
        color: var(--primary);
      }

      .sort-desc::after {
        content: ' ↓';
        color: var(--primary);
      }

      .status {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .status-approved {
        background: #d1fae5;
        color: #065f46;
      }

      .status-unused {
        background: #d1fae5;
        color: #065f46;
      }

      .status-used {
        background: #fee2e2;
        color: #991b1b;
      }

      .approve-btn {
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .approve-btn:hover {
        background: #16a34a;
        transform: translateY(-1px);
      }

      .promote-btn {
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .promote-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .demote-btn {
        background: var(--warning);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .demote-btn:hover {
        background: #d97706;
        transform: translateY(-1px);
      }

      .delete-btn {
        background: var(--danger);
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }

      .delete-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .status-admin {
        background: color-mix(in srgb, var(--primary), white 85%);
        color: var(--primary-dark);
        border-color: var(--primary);
      }

      .status-user {
        background: color-mix(in srgb, var(--text-light), white 90%);
        color: var(--text);
        border-color: var(--text-light);
      }

      .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .filters input,
      .filters select {
        padding: 0.625rem 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        background: var(--surface);
        color: var(--text);
        transition: border-color 0.2s;
        min-width: 200px;
      }

      .filters input:focus,
      .filters select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .pagination {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .pagination button {
        background: var(--primary);
        color: white;
        min-width: 100px;
      }

      .pagination button:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .pagination button:disabled {
        background: var(--border);
        color: var(--text-light);
        cursor: not-allowed;
        transform: none;
      }

      .pagination span {
        font-weight: 500;
        color: var(--text);
      }

      .invite-key-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--hover);
        border-radius: 12px;
        border: 2px dashed var(--border);
      }

      .invite-key-section h3 {
        margin: 0 0 1rem 0;
      }

      .invite-key-section button {
        background: var(--primary);
        color: white;
        width: 100%;
        margin-bottom: 1rem;
      }

      .invite-key-section button:hover {
        background: var(--primary-dark);
      }

      .invite-key-section input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.9rem;
        background: var(--surface);
        color: var(--text);
      }

      .copy-button,
      .cancel-button {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
      }

      .copy-button {
        background: var(--primary);
        color: white;
        font-family: monospace;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .copy-button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .cancel-button {
        background: var(--danger);
        color: white;
        margin-left: 0.5rem;
      }

      .cancel-button:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        animation: slideIn 0.3s ease-out;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 400px;
      }

      .notification i {
        font-size: 1.25rem;
      }

      .notification.success {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
      }

      .notification.success i {
        color: #10b981;
      }

      .notification.error {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #ef4444;
      }

      .notification.error i {
        color: #ef4444;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-light);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
      }

      .empty-state h3 {
        margin: 0 0 0.5rem 0;
        color: var(--text);
      }

      .empty-state p {
        margin: 0;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .btn-container {
          flex-direction: column;
        }

        .tab-container {
          overflow-x: auto;
        }

        .tab {
          white-space: nowrap;
          padding: 0.625rem 1rem;
          font-size: 0.9rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .filters {
          flex-direction: column;
        }

        .filters input,
        .filters select {
          width: 100%;
          min-width: 0;
        }

        table {
          font-size: 0.875rem;
        }

        th,
        td {
          padding: 0.75rem 0.5rem;
        }
      }

      .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-shield-alt"></i>
          Admin Dashboard
        </h1>
        <div class="btn-container">
          <button class="home-btn" onclick="window.location.href = '/'">
            <i class="fas fa-home"></i>
            Home
          </button>
          <button class="theme-btn" id="themeToggle" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
            <span id="themeToggleText">Dark Mode</span>
          </button>
          <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>

      <div class="tab-container">
        <button class="tab active" onclick="showTab('users')">
          <i class="fas fa-users"></i>
          Users
        </button>
        <button class="tab" onclick="showTab('usage')">
          <i class="fas fa-chart-line"></i>
          Usage Logs
        </button>
        <button class="tab" onclick="window.location.href='/admin/songs'">
          <i class="fas fa-music"></i>
          Songs
        </button>
        <button class="tab" onclick="window.location.href='/admin/status'">
          <i class="fas fa-heartbeat"></i>
          System Status
        </button>
      </div>

      <div id="usersTab">
        <div class="card invite-key-section">
          <h3><i class="fas fa-key"></i> Generate Invite Key</h3>
          <button onclick="generateInviteKey()">
            <i class="fas fa-plus-circle"></i>
            Generate New Key
          </button>
          <input
            type="text"
            id="inviteKeyDisplay"
            readonly
            placeholder="Generated key will appear here"
          />
        </div>

        <div class="card">
          <h3><i class="fas fa-key"></i> Invite Keys</h3>
          <div class="table-wrapper">
            <table id="inviteKeysTable">
              <thead>
                <tr>
                  <th onclick="sortTable('inviteKeysTable', 0)">Key</th>
                  <th onclick="sortTable('inviteKeysTable', 1)">Created By</th>
                  <th onclick="sortTable('inviteKeysTable', 2)">Created At</th>
                  <th onclick="sortTable('inviteKeysTable', 3)">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-users-cog"></i> User Management</h3>
          <div class="table-wrapper">
            <table id="usersTable">
              <thead>
                <tr>
                  <th onclick="sortTable('usersTable', 0)">Username</th>
                  <th onclick="sortTable('usersTable', 1)">Created At</th>
                  <th onclick="sortTable('usersTable', 2)">Status</th>
                  <th onclick="sortTable('usersTable', 3)">Role</th>
                  <th onclick="sortTable('usersTable', 4)">Last Online</th>
                  <th onclick="sortTable('usersTable', 5)">Activity</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="usageTab" style="display: none">
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users"></i>
            <h3>Total Users</h3>
            <p id="totalUsers">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-download"></i>
            <h3>Total Downloads</h3>
            <p id="totalDownloads">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-search"></i>
            <h3>Total Searches</h3>
            <p id="totalSearches">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-random"></i>
            <h3>Random Plays</h3>
            <p id="totalRandomPlays">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <h3>Most Active User</h3>
            <p id="mostActiveUser">-</p>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-history"></i> Usage Logs</h3>
          <div class="filters">
            <input
              type="text"
              id="usernameFilter"
              placeholder="🔍 Filter by username"
              onchange="loadUsageLogs(1)"
            />
            <select id="actionFilter" onchange="loadUsageLogs(1)">
              <option value="">All actions</option>
              <option value="download">Download</option>
              <option value="search">Search</option>
              <option value="random_play">Random Play</option>
            </select>
            <select id="perPage" onchange="loadUsageLogs(1)">
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
              <option value="200">200 per page</option>
            </select>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Action</th>
                  <th>Track ID</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="usageTableBody"></tbody>
            </table>
          </div>

          <div class="pagination">
            <button onclick="loadUsageLogs(currentPage - 1)" id="prevPage">
              <i class="fas fa-chevron-left"></i>
              Previous
            </button>
            <span id="pageInfo">Page 1 of 1</span>
            <button onclick="loadUsageLogs(currentPage + 1)" id="nextPage">
              Next
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
      function getTheme() {
        return localStorage.getItem('theme') || 'light'
      }
      function setTheme(theme) {
        localStorage.setItem('theme', theme)
        document.documentElement.setAttribute('data-theme', theme)
      }
      function updateThemeButton() {
        const btn = document.getElementById('themeToggle')
        const label = document.getElementById('themeToggleText')
        if (!btn || !label) return
        const theme = getTheme()
        btn.innerHTML =
          theme === 'light'
            ? '<i class="fas fa-moon"></i> <span id="themeToggleText">Dark Mode</span>'
            : '<i class="fas fa-sun"></i> <span id="themeToggleText">Light Mode</span>'
      }
      function toggleTheme() {
        const newTheme = getTheme() === 'light' ? 'dark' : 'light'
        setTheme(newTheme)
        updateThemeButton()
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString)
        const now = new Date()
        const diffInSeconds = Math.floor((now - date) / 1000)

        if (diffInSeconds < 60) return 'Just now'
        if (diffInSeconds < 3600)
          return `${Math.floor(diffInSeconds / 60)}m ago`
        if (diffInSeconds < 86400)
          return `${Math.floor(diffInSeconds / 3600)}h ago`
        if (diffInSeconds < 604800)
          return `${Math.floor(diffInSeconds / 86400)}d ago`
        return date.toLocaleDateString()
      }

      let currentSort = {
        column: null,
        direction: 'asc',
      }

      function sortTable(tableId, column) {
        const table = document.getElementById(tableId)
        const headers = table.getElementsByTagName('th')

        if (currentSort.column === column) {
          currentSort.direction =
            currentSort.direction === 'asc' ? 'desc' : 'asc'
        } else {
          currentSort.column = column
          currentSort.direction = 'asc'
        }

        Array.from(headers).forEach((header) => {
          header.classList.remove('sort-asc', 'sort-desc')
        })
        headers[column].classList.add(`sort-${currentSort.direction}`)

        const tbody = table.getElementsByTagName('tbody')[0]
        const rows = Array.from(tbody.getElementsByTagName('tr'))

        rows.sort((a, b) => {
          let aValue = a.cells[column].textContent
          let bValue = b.cells[column].textContent

          if (column === 1 || column === 3) {
            aValue = new Date(aValue)
            bValue = new Date(bValue)
          } else if (column === 4) {
            aValue = parseInt(aValue)
            bValue = parseInt(bValue)
          }

          if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1
          if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1
          return 0
        })

        rows.forEach((row) => tbody.appendChild(row))
      }

      let currentUserId = null

      async function getCurrentUser() {
        try {
          const response = await fetch('/admin/me', {
            credentials: 'include',
          })
          const data = await response.json()
          currentUserId = data.user_id
        } catch (error) {
          console.error('Error getting current user:', error)
        }
      }

      async function loadUsers() {
        try {
          // Ensure we have the current user ID
          if (currentUserId === null) {
            await getCurrentUser()
          }

          const response = await fetch('/admin/users', {
            credentials: 'include',
          })
          const users = await response.json()

          const tbody = document.querySelector('#usersTable tbody')
          tbody.innerHTML = users
            .map((user) => {
              const isCurrentUser = user.id === currentUserId

              return `
            <tr>
              <td><i class="fas fa-user"></i> ${user.username}${
                isCurrentUser
                  ? ' <span style="color: var(--primary); font-weight: 600;">(You)</span>'
                  : ''
              }</td>
              <td>${new Date(user.created_at).toLocaleString()}</td>
              <td>
                <span class="status ${
                  user.is_approved ? 'status-approved' : 'status-pending'
                }">
                  <i class="fas fa-${
                    user.is_approved ? 'check-circle' : 'clock'
                  }"></i>
                  ${user.is_approved ? 'Approved' : 'Pending'}
                </span>
              </td>
              <td>
                <span class="status ${
                  user.is_admin ? 'status-admin' : 'status-user'
                }">
                  <i class="fas fa-${
                    user.is_admin ? 'shield-alt' : 'user'
                  }"></i>
                  ${user.is_admin ? 'Admin' : 'User'}
                </span>
              </td>
              <td>${
                user.last_online ? formatTimeAgo(user.last_online) : 'Never'
              }</td>
              <td>${user.activity_count}</td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  ${
                    !user.is_approved
                      ? `<button class="approve-btn" onclick="approveUser(${user.id})" title="Approve user">
                          <i class="fas fa-check"></i> Approve
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser && !user.is_admin
                      ? `<button class="promote-btn" onclick="promoteUser(${user.id})" title="Promote to admin">
                          <i class="fas fa-arrow-up"></i> Promote
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser && user.is_admin
                      ? `<button class="demote-btn" onclick="demoteUser(${user.id})" title="Demote from admin">
                          <i class="fas fa-arrow-down"></i> Demote
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser
                      ? `<button class="delete-btn" onclick="deleteUser(${user.id}, '${user.username}')" title="Delete user">
                          <i class="fas fa-trash"></i> Delete
                         </button>`
                      : ''
                  }
                </div>
              </td>
            </tr>
          `
            })
            .join('')
        } catch (error) {
          console.error('Error loading users:', error)
        }
      }

      let currentPage = 1

      async function loadUsageLogs(page = 1) {
        try {
          const username = document.getElementById('usernameFilter').value
          const action = document.getElementById('actionFilter').value
          const perPage = document.getElementById('perPage').value

          const params = new URLSearchParams({
            page,
            per_page: perPage,
          })

          if (username) params.append('username', username)
          if (action) params.append('action', action)

          const response = await fetch(`/admin/usage?${params}`, {
            credentials: 'include',
          })
          const data = await response.json()

          currentPage = page

          const tbody = document.getElementById('usageTableBody')
          tbody.innerHTML = data.logs
            .map(
              (log) => `
                <tr>
                    <td><i class="fas fa-user"></i> ${log.username}</td>
                    <td><i class="fas fa-${
                      log.action === 'download'
                        ? 'download'
                        : log.action === 'search'
                        ? 'search'
                        : 'random'
                    }"></i> ${log.action}</td>
                    <td><code>${log.track_id}</code></td>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                </tr>
            `
            )
            .join('')

          document.getElementById(
            'pageInfo'
          ).textContent = `Page ${page} of ${data.total_pages}`
          document.getElementById('prevPage').disabled = page <= 1
          document.getElementById('nextPage').disabled =
            page >= data.total_pages
        } catch (error) {
          console.error('Error loading usage logs:', error)
        }
      }

      async function generateInviteKey() {
        try {
          const response = await fetch('/admin/invite-keys', {
            method: 'POST',
            credentials: 'include',
          })
          const data = await response.json()
          document.getElementById('inviteKeyDisplay').value = data.key
          showNotification('Invite key generated successfully!', 'success')
          loadInviteKeys()
        } catch (error) {
          console.error('Error generating invite key:', error)
          showNotification('Failed to generate invite key', 'error')
        }
      }

      async function approveUser(userId) {
        try {
          const response = await fetch(`/admin/users/${userId}/approve`, {
            method: 'POST',
            credentials: 'include',
          })
          if (response.ok) {
            showNotification('User approved successfully!', 'success')
            loadUsers()
          }
        } catch (error) {
          console.error('Error approving user:', error)
          showNotification('Failed to approve user', 'error')
        }
      }

      async function promoteUser(userId) {
        try {
          const response = await fetch(`/admin/users/${userId}/promote`, {
            method: 'POST',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User promoted to admin successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to promote user', 'error')
          }
        } catch (error) {
          console.error('Error promoting user:', error)
          showNotification('Failed to promote user', 'error')
        }
      }

      async function demoteUser(userId) {
        if (!confirm('Are you sure you want to demote this user from admin?')) {
          return
        }

        try {
          const response = await fetch(`/admin/users/${userId}/demote`, {
            method: 'POST',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User demoted from admin successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to demote user', 'error')
          }
        } catch (error) {
          console.error('Error demoting user:', error)
          showNotification('Failed to demote user', 'error')
        }
      }

      async function deleteUser(userId, username) {
        if (
          !confirm(
            `Are you sure you want to delete user "${username}"? This action cannot be undone.`
          )
        ) {
          return
        }

        try {
          const response = await fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User deleted successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to delete user', 'error')
          }
        } catch (error) {
          console.error('Error deleting user:', error)
          showNotification('Failed to delete user', 'error')
        }
      }

      async function logout() {
        try {
          await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include',
          })
          window.location.href = '/login'
        } catch (error) {
          console.error('Error logging out:', error)
        }
      }

      function showTab(tabName) {
        document.querySelectorAll('.tab').forEach((tab) => {
          tab.classList.remove('active')
        })
        document
          .querySelector(`.tab[onclick="showTab('${tabName}')"]`)
          .classList.add('active')

        document.getElementById('usersTab').style.display =
          tabName === 'users' ? 'block' : 'none'
        document.getElementById('usageTab').style.display =
          tabName === 'usage' ? 'block' : 'none'

        if (tabName === 'users') {
          loadUsers()
          loadInviteKeys()
        } else if (tabName === 'usage') {
          loadUsageLogs()
          loadStats()
        }
      }

      async function loadStats() {
        try {
          const response = await fetch('/admin/stats', {
            credentials: 'include',
          })
          const stats = await response.json()

          document.getElementById('totalUsers').textContent = stats.total_users
          document.getElementById('totalDownloads').textContent =
            stats.total_downloads
          document.getElementById('totalSearches').textContent =
            stats.total_searches
          document.getElementById('totalRandomPlays').textContent =
            stats.total_random_plays
          document.getElementById('mostActiveUser').textContent =
            stats.most_active_user
              ? `${stats.most_active_user.username} (${stats.most_active_user.count})`
              : '-'
        } catch (error) {
          console.error('Error loading stats:', error)
        }
      }

      async function loadInviteKeys() {
        try {
          const response = await fetch('/admin/invite-keys', {
            credentials: 'include',
          })
          const keys = await response.json()

          const tbody = document.querySelector('#inviteKeysTable tbody')
          tbody.innerHTML = keys
            .map(
              (key) => `
            <tr>
              <td>
                <button class="copy-button" onclick="copyToClipboard('${
                  key.key
                }')">
                  <i class="fas fa-copy"></i> ${key.key}
                </button>
              </td>
              <td>${key.created_by || '-'}</td>
              <td>${new Date(key.created_at).toLocaleString()}</td>
              <td>
                <span class="status ${
                  key.used_by ? 'status-used' : 'status-unused'
                }">
                  <i class="fas fa-${
                    key.used_by ? 'times-circle' : 'check-circle'
                  }"></i>
                  ${key.used_by ? 'Used' : 'Available'}
                </span>
              </td>
              <td>
                ${
                  !key.used_by
                    ? `<button class="cancel-button" onclick="cancelInviteKey('${key.key}')">
                        <i class="fas fa-trash"></i> Cancel
                      </button>`
                    : `${key.used_by} <br> <small>${
                        key.used_at
                          ? new Date(key.used_at).toLocaleString()
                          : ''
                      }</small>`
                }
              </td>
            </tr>
          `
            )
            .join('')
        } catch (error) {
          console.error('Error loading invite keys:', error)
        }
      }

      async function cancelInviteKey(key) {
        if (!confirm('Are you sure you want to cancel this invite key?')) {
          return
        }

        try {
          const response = await fetch(`/admin/invite-keys/${key}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          if (response.ok) {
            showNotification('Invite key cancelled successfully!', 'success')
            loadInviteKeys()
          } else {
            const data = await response.json()
            showNotification(
              data.error || 'Failed to cancel invite key',
              'error'
            )
          }
        } catch (error) {
          console.error('Error cancelling invite key:', error)
          showNotification('Failed to cancel invite key', 'error')
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showNotification('Invite key copied to clipboard!', 'success')
          })
          .catch((err) => {
            console.error('Failed to copy text: ', err)
            showNotification('Failed to copy to clipboard', 'error')
          })
      }

      function showNotification(message, type) {
        const notification = document.createElement('div')
        notification.className = `notification ${type}`
        notification.innerHTML = `
          <i class="fas fa-${
            type === 'success' ? 'check-circle' : 'exclamation-circle'
          }"></i>
          ${message}
        `
        document.body.appendChild(notification)
        setTimeout(() => notification.remove(), 3000)
      }

      document.addEventListener('DOMContentLoaded', () => {
        setTheme(getTheme())
        updateThemeButton()
        loadUsers()
        loadInviteKeys()
      })
    </script>
  </body>
</html>
