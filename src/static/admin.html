<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - MelodAI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="icon" href="/logo.svg" />
    <link rel="stylesheet" href="/css/base.css" />
    <link rel="stylesheet" href="/css/admin.css" />
  </head>
  <body class="admin-page">
    <div class="container">
      <header class="page-header">
        <h1>
          <i class="fas fa-shield-alt"></i>
          Admin Dashboard
        </h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="toggleTheme()">
            <i class="fas fa-moon" id="themeIcon"></i>
          </button>
          <a href="/" class="btn btn-primary">
            <i class="fas fa-home"></i>
            Home
          </a>
          <button class="btn btn-danger" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </header>

      <nav class="tabs">
        <button class="tab active" onclick="showTab('users')">
          <i class="fas fa-users"></i>
          Users
        </button>
        <button class="tab" onclick="showTab('usage')">
          <i class="fas fa-chart-line"></i>
          Usage
        </button>
        <button class="tab" onclick="showTab('songs')">
          <i class="fas fa-music"></i>
          Songs
        </button>
        <button class="tab" onclick="showTab('status')">
          <i class="fas fa-heartbeat"></i>
          Status
        </button>
      </nav>

      <div id="usersTab" class="tab-content active">
        <div class="invite-section">
          <h3><i class="fas fa-key"></i> Generate Invite Key</h3>
          <button class="btn btn-primary" onclick="generateInviteKey()">
            <i class="fas fa-plus-circle"></i>
            Generate New Key
          </button>
          <input type="text" id="inviteKeyDisplay" class="invite-display" readonly placeholder="Generated key will appear here" />
        </div>

        <div class="card">
          <h3><i class="fas fa-key"></i> Invite Keys</h3>
          <div class="table-wrapper">
            <table id="inviteKeysTable">
              <thead>
                <tr>
                  <th onclick="sortTable('inviteKeysTable', 0)">Key</th>
                  <th onclick="sortTable('inviteKeysTable', 1)">Created By</th>
                  <th onclick="sortTable('inviteKeysTable', 2)">Created At</th>
                  <th onclick="sortTable('inviteKeysTable', 3)">Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-users-cog"></i> User Management</h3>
          <div class="table-wrapper">
            <table id="usersTable">
              <thead>
                <tr>
                  <th onclick="sortTable('usersTable', 0)">Username</th>
                  <th onclick="sortTable('usersTable', 1)">Created At</th>
                  <th onclick="sortTable('usersTable', 2)">Status</th>
                  <th onclick="sortTable('usersTable', 3)">Role</th>
                  <th onclick="sortTable('usersTable', 4)">Last Online</th>
                  <th onclick="sortTable('usersTable', 5)">Activity</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="usageTab" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users"></i>
            <h3>Total Users</h3>
            <p id="totalUsers">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-download"></i>
            <h3>Total Downloads</h3>
            <p id="totalDownloads">-</p>
          </div>
            <div class="stat-card">
              <i class="fas fa-play"></i>
              <h3>Total Plays</h3>
              <p id="totalPlays">-</p>
            </div>
          <div class="stat-card">
            <i class="fas fa-search"></i>
            <h3>Total Searches</h3>
            <p id="totalSearches">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-random"></i>
            <h3>Random Plays</h3>
            <p id="totalRandomPlays">-</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <h3>Most Active User</h3>
            <p id="mostActiveUser">-</p>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-history"></i> Usage Logs</h3>
          <div class="filters">
            <input
              type="text"
              id="usernameFilter"
              placeholder="ðŸ” Filter by username"
              onchange="loadUsageLogs(1)"
            />
            <select id="actionFilter" onchange="loadUsageLogs(1)">
              <option value="">All actions</option>
              <option value="download">Download</option>
              <option value="play">Play</option>
              <option value="search">Search</option>
              <option value="random_play">Random Play</option>
            </select>
            <select id="perPage" onchange="loadUsageLogs(1)">
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
              <option value="200">200 per page</option>
            </select>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Action</th>
                  <th>Track ID</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="usageTableBody"></tbody>
            </table>
          </div>

          <div class="pagination">
            <button onclick="loadUsageLogs(currentPage - 1)" id="prevPage">
              <i class="fas fa-chevron-left"></i>
              Previous
            </button>
            <span id="pageInfo">Page 1 of 1</span>
            <button onclick="loadUsageLogs(currentPage + 1)" id="nextPage">
              Next
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Songs Tab -->
      <div id="songsTab" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-music"></i>
            <h3>Total Songs</h3>
            <p id="totalSongs">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <h3>Complete Songs</h3>
            <p id="completeSongs">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-hdd"></i>
            <h3>Total Storage</h3>
            <p id="totalStorage">0 MB</p>
          </div>
        </div>

        <div class="card">
          <div class="controls">
            <div class="search-box">
              <input
                type="text"
                id="searchInput"
                placeholder="ðŸ” Search by title, artist, or album..."
                onkeyup="filterSongs()"
              />
            </div>
            <select
              id="filterSelect"
              class="filter-select"
              onchange="filterSongs()"
            >
              <option value="all">All Songs</option>
              <option value="complete">Complete Only</option>
              <option value="incomplete">Incomplete Only</option>
            </select>
            <button class="refresh-btn" onclick="loadSongs()">
              <i class="fas fa-sync-alt" id="refreshSongsIcon"></i>
              Refresh
            </button>
          </div>

          <div class="table-wrapper">
            <table id="songsTable">
              <thead>
                <tr>
                  <th onclick="sortSongsTable(0)">Song</th>
                  <th onclick="sortSongsTable(1)">Album</th>
                  <th onclick="sortSongsTable(2)">Duration</th>
                  <th onclick="sortSongsTable(3)">Size</th>
                  <th onclick="sortSongsTable(4)">Status</th>
                  <th onclick="sortSongsTable(5)">Track ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="songsTableBody">
                <tr>
                  <td colspan="7">
                    <div class="loading">
                      <div class="spinner"></div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Status Tab -->
      <div id="statusTab" class="tab-content">
        <div class="info-banner">
          <p>
            <i class="fas fa-info-circle"></i>
            Last updated: <strong id="statusLastUpdated">Never</strong>
          </p>
        </div>

        <div class="tabs">
          <button class="tab active" data-subtab="current-status">
            <i class="fas fa-heartbeat"></i>
            Current Status
          </button>
          <button class="tab" data-subtab="processing-queue">
            <i class="fas fa-list"></i>
            Processing Queue
          </button>
          <button class="tab" data-subtab="unfinished-tracks">
            <i class="fas fa-exclamation-triangle"></i>
            Unfinished Tracks
          </button>
        </div>

        <!-- Current Status Sub-tab -->
        <div id="current-status" class="tab-content active">
          <div id="currentStatus">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Processing Queue Sub-tab -->
        <div id="processing-queue" class="tab-content">
          <div class="queue-header">
            <div class="queue-count" id="queueCount">0 tracks in queue</div>
            <button class="btn-secondary" onclick="fetchProcessingQueue()">
              <i class="fas fa-sync-alt" id="refreshQueueIcon"></i>
              Refresh Queue
            </button>
          </div>
          <div id="processingQueue">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- Unfinished Tracks Sub-tab -->
        <div id="unfinished-tracks" class="tab-content">
          <div class="queue-header">
            <div class="queue-count" id="unfinishedCount">
              Loading unfinished tracks...
            </div>
            <button class="btn-secondary" onclick="fetchUnfinishedSongs()">
              <i class="fas fa-sync-alt" id="refreshUnfinishedIcon"></i>
              Refresh List
            </button>
          </div>
          <div id="unfinishedSongs">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
      // Theme Management
      function getTheme() {
        return localStorage.getItem('theme') || 'light';
      }

      function setTheme(theme) {
        localStorage.setItem('theme', theme);
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.getElementById('themeIcon');
        if (icon) icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
      }

      function toggleTheme() {
        const newTheme = getTheme() === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
      }

      // Initialize theme on load
      setTheme(getTheme());
    </script>
    <script>
      function formatTimeAgo(dateString) {
        const date = new Date(dateString)
        const now = new Date()
        const diffInSeconds = Math.floor((now - date) / 1000)

        if (diffInSeconds < 60) return 'Just now'
        if (diffInSeconds < 3600)
          return `${Math.floor(diffInSeconds / 60)}m ago`
        if (diffInSeconds < 86400)
          return `${Math.floor(diffInSeconds / 3600)}h ago`
        if (diffInSeconds < 604800)
          return `${Math.floor(diffInSeconds / 86400)}d ago`
        return date.toLocaleDateString()
      }

      let currentSort = {
        column: null,
        direction: 'asc',
      }

      function sortTable(tableId, column) {
        const table = document.getElementById(tableId)
        const headers = table.getElementsByTagName('th')

        if (currentSort.column === column) {
          currentSort.direction =
            currentSort.direction === 'asc' ? 'desc' : 'asc'
        } else {
          currentSort.column = column
          currentSort.direction = 'asc'
        }

        Array.from(headers).forEach((header) => {
          header.classList.remove('sort-asc', 'sort-desc')
        })
        headers[column].classList.add(`sort-${currentSort.direction}`)

        const tbody = table.getElementsByTagName('tbody')[0]
        const rows = Array.from(tbody.getElementsByTagName('tr'))

        rows.sort((a, b) => {
          let aValue = a.cells[column].textContent
          let bValue = b.cells[column].textContent

          if (column === 1 || column === 3) {
            aValue = new Date(aValue)
            bValue = new Date(bValue)
          } else if (column === 4) {
            aValue = parseInt(aValue)
            bValue = parseInt(bValue)
          }

          if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1
          if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1
          return 0
        })

        rows.forEach((row) => tbody.appendChild(row))
      }

      let currentUserId = null

      async function getCurrentUser() {
        try {
          const response = await fetch('/admin/me', {
            credentials: 'include',
          })
          const data = await response.json()
          currentUserId = data.user_id
        } catch (error) {
          console.error('Error getting current user:', error)
        }
      }

      async function loadUsers() {
        try {
          // Ensure we have the current user ID
          if (currentUserId === null) {
            await getCurrentUser()
          }

          const response = await fetch('/admin/users', {
            credentials: 'include',
          })
          const users = await response.json()

          const tbody = document.querySelector('#usersTable tbody')
          tbody.innerHTML = users
            .map((user) => {
              const isCurrentUser = user.id === currentUserId

              return `
            <tr>
              <td><i class="fas fa-user"></i> ${user.username}${
                isCurrentUser
                  ? ' <span style="color: var(--primary); font-weight: 600;">(You)</span>'
                  : ''
              }</td>
              <td>${new Date(user.created_at).toLocaleString()}</td>
              <td>
                <span class="status ${
                  user.is_approved ? 'status-approved' : 'status-pending'
                }">
                  <i class="fas fa-${
                    user.is_approved ? 'check-circle' : 'clock'
                  }"></i>
                  ${user.is_approved ? 'Approved' : 'Pending'}
                </span>
              </td>
              <td>
                <span class="status ${
                  user.is_admin ? 'status-admin' : 'status-user'
                }">
                  <i class="fas fa-${
                    user.is_admin ? 'shield-alt' : 'user'
                  }"></i>
                  ${user.is_admin ? 'Admin' : 'User'}
                </span>
              </td>
              <td>${
                user.last_online ? formatTimeAgo(user.last_online) : 'Never'
              }</td>
              <td>${user.activity_count}</td>
              <td>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  ${
                    !user.is_approved
                      ? `<button class="approve-btn" onclick="approveUser(${user.id})" title="Approve user">
                          <i class="fas fa-check"></i> Approve
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser && !user.is_admin
                      ? `<button class="promote-btn" onclick="promoteUser(${user.id})" title="Promote to admin">
                          <i class="fas fa-arrow-up"></i> Promote
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser && user.is_admin
                      ? `<button class="demote-btn" onclick="demoteUser(${user.id})" title="Demote from admin">
                          <i class="fas fa-arrow-down"></i> Demote
                         </button>`
                      : ''
                  }
                  ${
                    !isCurrentUser
                      ? `<button class="delete-btn" onclick="deleteUser(${user.id}, '${user.username}')" title="Delete user">
                          <i class="fas fa-trash"></i> Delete
                         </button>`
                      : ''
                  }
                </div>
              </td>
            </tr>
          `
            })
            .join('')
        } catch (error) {
          console.error('Error loading users:', error)
        }
      }

      let currentPage = 1

      async function loadUsageLogs(page = 1) {
        try {
          const username = document.getElementById('usernameFilter').value
          const action = document.getElementById('actionFilter').value
          const perPage = document.getElementById('perPage').value

          const params = new URLSearchParams({
            page,
            per_page: perPage,
          })

          if (username) params.append('username', username)
          if (action) params.append('action', action)

          const response = await fetch(`/admin/usage?${params}`, {
            credentials: 'include',
          })
          const data = await response.json()

          currentPage = page

          const tbody = document.getElementById('usageTableBody')
          tbody.innerHTML = data.logs
            .map(
              (log) => `
                <tr>
                    <td><i class="fas fa-user"></i> ${log.username}</td>
                    <td><i class="fas fa-${
                      log.action === 'download'
                        ? 'download'
                        : log.action === 'search'
                        ? 'search'
                        : log.action === 'play'
                        ? 'play'
                        : 'random'
                    }"></i> ${log.action}</td>
                    <td><code>${log.track_id}</code></td>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                </tr>
            `
            )
            .join('')

          document.getElementById(
            'pageInfo'
          ).textContent = `Page ${page} of ${data.total_pages}`
          document.getElementById('prevPage').disabled = page <= 1
          document.getElementById('nextPage').disabled =
            page >= data.total_pages
        } catch (error) {
          console.error('Error loading usage logs:', error)
        }
      }

      async function generateInviteKey() {
        try {
          const response = await fetch('/admin/invite-keys', {
            method: 'POST',
            credentials: 'include',
          })
          const data = await response.json()
          document.getElementById('inviteKeyDisplay').value = data.key
          showNotification('Invite key generated successfully!', 'success')
          loadInviteKeys()
        } catch (error) {
          console.error('Error generating invite key:', error)
          showNotification('Failed to generate invite key', 'error')
        }
      }

      async function approveUser(userId) {
        try {
          const response = await fetch(`/admin/users/${userId}/approve`, {
            method: 'POST',
            credentials: 'include',
          })
          if (response.ok) {
            showNotification('User approved successfully!', 'success')
            loadUsers()
          }
        } catch (error) {
          console.error('Error approving user:', error)
          showNotification('Failed to approve user', 'error')
        }
      }

      async function promoteUser(userId) {
        try {
          const response = await fetch(`/admin/users/${userId}/promote`, {
            method: 'POST',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User promoted to admin successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to promote user', 'error')
          }
        } catch (error) {
          console.error('Error promoting user:', error)
          showNotification('Failed to promote user', 'error')
        }
      }

      async function demoteUser(userId) {
        if (!confirm('Are you sure you want to demote this user from admin?')) {
          return
        }

        try {
          const response = await fetch(`/admin/users/${userId}/demote`, {
            method: 'POST',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User demoted from admin successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to demote user', 'error')
          }
        } catch (error) {
          console.error('Error demoting user:', error)
          showNotification('Failed to demote user', 'error')
        }
      }

      async function deleteUser(userId, username) {
        if (
          !confirm(
            `Are you sure you want to delete user "${username}"? This action cannot be undone.`
          )
        ) {
          return
        }

        try {
          const response = await fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('User deleted successfully!', 'success')
            loadUsers()
          } else {
            showNotification(data.error || 'Failed to delete user', 'error')
          }
        } catch (error) {
          console.error('Error deleting user:', error)
          showNotification('Failed to delete user', 'error')
        }
      }

      async function logout() {
        try {
          await fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include',
          })
          window.location.href = '/login'
        } catch (error) {
          console.error('Error logging out:', error)
        }
      }

      function showTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tabs > .tab').forEach((tab) => {
          tab.classList.remove('active')
        })
        document.querySelector(`.tabs > .tab[onclick="showTab('${tabName}')"]`).classList.add('active')

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active')
        })
        document.getElementById(tabName + 'Tab').classList.add('active')

        if (tabName === 'users') {
          loadUsers()
          loadInviteKeys()
        } else if (tabName === 'usage') {
          loadUsageLogs()
          loadStats()
        } else if (tabName === 'songs') {
          loadSongs()
        } else if (tabName === 'status') {
          fetchCurrentStatus()
        }
      }

      // Status Sub-tab handling
      document.addEventListener('DOMContentLoaded', () => {
        // Handle status sub-tabs
        document.querySelectorAll('.tabs .tab[data-subtab]').forEach((tab) => {
          tab.addEventListener('click', () => {
            const subtabName = tab.dataset.subtab

            // Update active tab
            document
              .querySelectorAll('.tabs .tab')
              .forEach((t) => t.classList.remove('active'))
            tab.classList.add('active')

            // Update active content
            document
              .querySelectorAll('#statusTab .tab-content')
              .forEach((content) => content.classList.remove('active'))
            document.getElementById(subtabName).classList.add('active')

            // Load data if needed
            if (subtabName === 'processing-queue') fetchProcessingQueue()
            if (subtabName === 'unfinished-tracks') fetchUnfinishedSongs()
          })
        })
      })

      async function loadStats() {
        try {
          const response = await fetch('/admin/stats', {
            credentials: 'include',
          })
          const stats = await response.json()

          document.getElementById('totalUsers').textContent = stats.total_users
          document.getElementById('totalDownloads').textContent =
            stats.total_downloads
          document.getElementById('totalPlays').textContent =
            stats.total_plays
          document.getElementById('totalSearches').textContent =
            stats.total_searches
          document.getElementById('totalRandomPlays').textContent =
            stats.total_random_plays
          document.getElementById('mostActiveUser').textContent =
            stats.most_active_user
              ? `${stats.most_active_user.username} (${stats.most_active_user.count})`
              : '-'
        } catch (error) {
          console.error('Error loading stats:', error)
        }
      }

      async function loadInviteKeys() {
        try {
          const response = await fetch('/admin/invite-keys', {
            credentials: 'include',
          })
          const keys = await response.json()

          const tbody = document.querySelector('#inviteKeysTable tbody')
          tbody.innerHTML = keys
            .map(
              (key) => `
            <tr>
              <td>
                <button class="copy-button" onclick="copyToClipboard('${
                  key.key
                }')">
                  <i class="fas fa-copy"></i> ${key.key}
                </button>
              </td>
              <td>${key.created_by || '-'}</td>
              <td>${new Date(key.created_at).toLocaleString()}</td>
              <td>
                <span class="status ${
                  key.used_by ? 'status-used' : 'status-unused'
                }">
                  <i class="fas fa-${
                    key.used_by ? 'times-circle' : 'check-circle'
                  }"></i>
                  ${key.used_by ? 'Used' : 'Available'}
                </span>
              </td>
              <td>
                ${
                  !key.used_by
                    ? `<button class="cancel-button" onclick="cancelInviteKey('${key.key}')">
                        <i class="fas fa-trash"></i> Cancel
                      </button>`
                    : `${key.used_by} <br> <small>${
                        key.used_at
                          ? new Date(key.used_at).toLocaleString()
                          : ''
                      }</small>`
                }
              </td>
            </tr>
          `
            )
            .join('')
        } catch (error) {
          console.error('Error loading invite keys:', error)
        }
      }

      async function cancelInviteKey(key) {
        if (!confirm('Are you sure you want to cancel this invite key?')) {
          return
        }

        try {
          const response = await fetch(`/admin/invite-keys/${key}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          if (response.ok) {
            showNotification('Invite key cancelled successfully!', 'success')
            loadInviteKeys()
          } else {
            const data = await response.json()
            showNotification(
              data.error || 'Failed to cancel invite key',
              'error'
            )
          }
        } catch (error) {
          console.error('Error cancelling invite key:', error)
          showNotification('Failed to cancel invite key', 'error')
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showNotification('Invite key copied to clipboard!', 'success')
          })
          .catch((err) => {
            console.error('Failed to copy text: ', err)
            showNotification('Failed to copy to clipboard', 'error')
          })
      }

      function showNotification(message, type) {
        const notification = document.createElement('div')
        notification.className = `notification ${type}`
        notification.innerHTML = `
          <i class="fas fa-${
            type === 'success' ? 'check-circle' : 'exclamation-circle'
          }"></i>
          ${message}
        `
        document.body.appendChild(notification)
        setTimeout(() => notification.remove(), 3000)
      }

      // === SONGS TAB FUNCTIONS ===
      let allSongs = []
      let currentSongsSort = {
        column: null,
        direction: 'asc',
      }

      async function loadSongs() {
        const refreshIcon = document.getElementById('refreshSongsIcon')
        if (refreshIcon)
          refreshIcon.style.animation = 'spin 0.8s linear infinite'

        try {
          const response = await fetch('/admin/songs/list', {
            credentials: 'include',
          })
          const data = await response.json()
          allSongs = data.songs

          updateSongsStats()
          displaySongs(allSongs)
        } catch (error) {
          console.error('Error loading songs:', error)
          const tbody = document.getElementById('songsTableBody')
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error loading songs</h3>
                    <p>${error.message}</p>
                  </div>
                </td>
              </tr>
            `
          }
        } finally {
          if (refreshIcon) refreshIcon.style.animation = ''
        }
      }

      function updateSongsStats() {
        const totalSongs = allSongs.length
        const completeSongs = allSongs.filter(
          (s) => s.has_song && s.has_vocals && s.has_no_vocals && s.has_lyrics
        ).length
        const totalStorage = allSongs.reduce((sum, s) => sum + s.size_mb, 0)

        const totalEl = document.getElementById('totalSongs')
        const completeEl = document.getElementById('completeSongs')
        const storageEl = document.getElementById('totalStorage')

        if (totalEl) totalEl.textContent = totalSongs
        if (completeEl) completeEl.textContent = completeSongs
        if (storageEl) storageEl.textContent = totalStorage.toFixed(2) + ' MB'
      }

      function displaySongs(songs) {
        const tbody = document.getElementById('songsTableBody')
        if (!tbody) return

        if (songs.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <i class="fas fa-music"></i>
                  <h3>No songs found</h3>
                  <p>No songs match your search criteria.</p>
                </div>
              </td>
            </tr>
          `
          return
        }

        tbody.innerHTML = songs
          .map((song) => {
            const isComplete =
              song.has_song &&
              song.has_vocals &&
              song.has_no_vocals &&
              song.has_lyrics
            const coverUrl = song.cover
              ? `https://e-cdns-images.dzcdn.net/images/cover/${song.cover}/250x250-000000-80-0-0.jpg`
              : ''

            const statusBadges = []
            if (!song.has_song)
              statusBadges.push(
                '<span class="badge badge-danger"><i class="fas fa-times"></i> Song</span>'
              )
            if (!song.has_vocals)
              statusBadges.push(
                '<span class="badge badge-danger"><i class="fas fa-times"></i> Vocals</span>'
              )
            if (!song.has_no_vocals)
              statusBadges.push(
                '<span class="badge badge-danger"><i class="fas fa-times"></i> Instrumental</span>'
              )
            if (!song.has_lyrics)
              statusBadges.push(
                '<span class="badge badge-danger"><i class="fas fa-times"></i> Lyrics</span>'
              )

            const statusDisplay = isComplete
              ? '<span class="badge badge-success"><i class="fas fa-check"></i> Complete</span>'
              : statusBadges.join(' ')

            return `
              <tr>
                <td>
                  <div class="song-info">
                    ${
                      coverUrl
                        ? `<img src="${coverUrl}" alt="${song.title}" class="song-cover" />`
                        : '<div class="song-cover"></div>'
                    }
                    <div class="song-details">
                      <h4>${song.title}</h4>
                      <p>${song.artist}</p>
                    </div>
                  </div>
                </td>
                <td>${song.album}</td>
                <td>${formatDuration(song.duration)}</td>
                <td>${song.size_mb} MB</td>
                <td>${statusDisplay}</td>
                <td><code>${song.track_id}</code></td>
                <td>
                  <button 
                    class="delete-btn" 
                    onclick="deleteSong('${song.track_id}')"
                    title="Delete this song permanently"
                  >
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </td>
              </tr>
            `
          })
          .join('')
      }

      function formatDuration(seconds) {
        const mins = Math.floor(seconds / 60)
        const secs = seconds % 60
        return `${mins}:${secs.toString().padStart(2, '0')}`
      }

      function filterSongs() {
        const searchInput = document.getElementById('searchInput')
        const filterSelect = document.getElementById('filterSelect')
        if (!searchInput || !filterSelect) return

        const searchTerm = searchInput.value.toLowerCase()
        const filter = filterSelect.value

        let filtered = allSongs

        // Apply search filter
        if (searchTerm) {
          filtered = filtered.filter(
            (s) =>
              s.title.toLowerCase().includes(searchTerm) ||
              s.artist.toLowerCase().includes(searchTerm) ||
              s.album.toLowerCase().includes(searchTerm) ||
              s.track_id.includes(searchTerm)
          )
        }

        // Apply status filter
        if (filter === 'complete') {
          filtered = filtered.filter(
            (s) => s.has_song && s.has_vocals && s.has_no_vocals && s.has_lyrics
          )
        } else if (filter === 'incomplete') {
          filtered = filtered.filter(
            (s) =>
              !s.has_song || !s.has_vocals || !s.has_no_vocals || !s.has_lyrics
          )
        }

        displaySongs(filtered)
      }

      function sortSongsTable(column) {
        const headers = document.querySelectorAll('#songsTable th')

        if (currentSongsSort.column === column) {
          currentSongsSort.direction =
            currentSongsSort.direction === 'asc' ? 'desc' : 'asc'
        } else {
          currentSongsSort.column = column
          currentSongsSort.direction = 'asc'
        }

        // Remove sort classes
        headers.forEach((h) => h.classList.remove('sort-asc', 'sort-desc'))
        headers[column].classList.add(`sort-${currentSongsSort.direction}`)

        // Sort the songs
        const sortedSongs = [...allSongs].sort((a, b) => {
          let aVal, bVal

          switch (column) {
            case 0: // Song
              aVal = a.title.toLowerCase()
              bVal = b.title.toLowerCase()
              break
            case 1: // Album
              aVal = a.album.toLowerCase()
              bVal = b.album.toLowerCase()
              break
            case 2: // Duration
              aVal = a.duration
              bVal = b.duration
              break
            case 3: // Size
              aVal = a.size_mb
              bVal = b.size_mb
              break
            case 4: // Status
              aVal =
                a.has_song && a.has_vocals && a.has_no_vocals && a.has_lyrics
                  ? 1
                  : 0
              bVal =
                b.has_song && b.has_vocals && b.has_no_vocals && b.has_lyrics
                  ? 1
                  : 0
              break
            case 5: // Track ID
              aVal = a.track_id
              bVal = b.track_id
              break
            default:
              return 0
          }

          if (aVal < bVal) return currentSongsSort.direction === 'asc' ? -1 : 1
          if (aVal > bVal) return currentSongsSort.direction === 'asc' ? 1 : -1
          return 0
        })

        allSongs = sortedSongs
        filterSongs()
      }

      async function deleteSong(trackId) {
        if (
          !confirm(
            `Are you sure you want to permanently delete this song?\n\nTrack ID: ${trackId}\n\nThis action cannot be undone and will delete all associated files.`
          )
        ) {
          return
        }

        try {
          const response = await fetch(`/admin/songs/${trackId}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('Song deleted successfully!', 'success')
            // Remove from local array
            allSongs = allSongs.filter((s) => s.track_id !== trackId)
            updateSongsStats()
            filterSongs()
          } else {
            throw new Error(data.error || 'Failed to delete song')
          }
        } catch (error) {
          console.error('Error deleting song:', error)
          showNotification(error.message, 'error')
        }
      }

      // === STATUS TAB FUNCTIONS ===
      function formatDateTime(dateStr) {
        if (!dateStr) return 'Unknown'
        try {
          const date = new Date(dateStr)
          if (isNaN(date.getTime())) throw new Error('Invalid date')
          return date.toLocaleString()
        } catch (error) {
          return dateStr
        }
      }

      async function fetchCurrentStatus() {
        const refreshIcon = document.getElementById('refreshIcon')
        const container = document.getElementById('currentStatus')
        if (!container) return

        try {
          const response = await fetch(
            `/admin/status/check?timestamp=${Date.now()}`,
            {
              credentials: 'include',
            }
          )
          const data = await response.json()
          displayCurrentStatus(data.checks)
          const updateEl = document.getElementById('statusLastUpdated')
          if (updateEl) updateEl.textContent = new Date().toLocaleString()
        } catch (error) {
          console.error('Error fetching status:', error)
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading status</h3>
              <p>${error.message}</p>
            </div>
          `
        }
      }

      function displayCurrentStatus(checks) {
        const container = document.getElementById('currentStatus')
        if (!container) return

        container.innerHTML = ''

        checks.forEach((check) => {
          const statusBar = document.createElement('div')
          statusBar.className = 'status-bar'

          const statusClass = check.status.toLowerCase()

          statusBar.innerHTML = `
            <div class="status-bar-header">
              <div class="status-bar-title">${check.component}</div>
              <div class="status-badge ${statusClass}">
                ${check.status === 'OK' ? 'âœ“ Operational' : check.status}
              </div>
            </div>
            <div class="status-details">
              ${check.details}
            </div>
          `

          container.appendChild(statusBar)
        })
      }

      async function fetchProcessingQueue(showSpinner = true) {
        const icon = document.getElementById('refreshQueueIcon')
        const container = document.getElementById('processingQueue')
        if (!container) return

        if (showSpinner && icon) {
          icon.style.animation = 'spin 0.8s linear infinite'
        }

        try {
          const response = await fetch(
            `/admin/status/queue?timestamp=${Date.now()}`,
            {
              credentials: 'include',
            }
          )
          const data = await response.json()
          displayProcessingQueue(data.queue)
          const countEl = document.getElementById('queueCount')
          if (countEl) {
            countEl.textContent = `${data.queue.length} track${
              data.queue.length !== 1 ? 's' : ''
            } in queue`
          }
        } catch (error) {
          console.error('Error fetching queue:', error)
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading queue</h3>
              <p>${error.message}</p>
            </div>
          `
        } finally {
          if (showSpinner && icon) {
            icon.style.animation = ''
          }
        }
      }

      function displayProcessingQueue(queue) {
        const container = document.getElementById('processingQueue')
        if (!container) return

        if (queue.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h3>No tracks in queue</h3>
              <p>The processing queue is empty.</p>
            </div>
          `
          return
        }

        container.innerHTML = queue
          .map((item) => {
            let itemClass = 'queue-item'
            if (item.status.includes('error')) itemClass += ' error'
            else if (item.progress >= 50) itemClass += ' success'

            return `
              <div class="${itemClass}">
                <div class="queue-item-header">
                  <div class="queue-item-info">
                    <h3>${item.title || 'Unknown Track'}</h3>
                    <p>${item.artist || 'Unknown Artist'} â€¢ Track ID: ${
              item.track_id
            }</p>
                  </div>
                  <div class="queue-status">${formatStatus(item.status)}</div>
                </div>
                <div class="progress-bar-container">
                  <div class="progress-info">
                    <span>${item.progress}% complete</span>
                    <span>Time elapsed: ${item.elapsed_time}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${
                      item.progress
                    }%"></div>
                  </div>
                </div>
              </div>
            `
          })
          .join('')
      }

      function formatStatus(status) {
        return status
          .split('_')
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ')
      }

      async function fetchUnfinishedSongs(showSpinner = true) {
        const icon = document.getElementById('refreshUnfinishedIcon')
        const container = document.getElementById('unfinishedSongs')
        if (!container) return

        if (showSpinner && icon) {
          icon.style.animation = 'spin 0.8s linear infinite'
        }

        try {
          const response = await fetch(
            `/admin/status/unfinished?timestamp=${Date.now()}`,
            {
              credentials: 'include',
            }
          )
          const data = await response.json()
          displayUnfinishedSongs(data.unfinished_songs)
          const countEl = document.getElementById('unfinishedCount')
          if (countEl) {
            countEl.textContent = `${
              data.unfinished_songs.length
            } unfinished track${
              data.unfinished_songs.length !== 1 ? 's' : ''
            } found`
          }
        } catch (error) {
          console.error('Error fetching unfinished songs:', error)
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading unfinished tracks</h3>
              <p>${error.message}</p>
            </div>
          `
        } finally {
          if (showSpinner && icon) {
            icon.style.animation = ''
          }
        }
      }

      function displayUnfinishedSongs(songs) {
        const container = document.getElementById('unfinishedSongs')
        if (!container) return

        if (songs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-check-circle"></i>
              <h3>No unfinished tracks</h3>
              <p>All tracks have been processed successfully.</p>
            </div>
          `
          return
        }

        const tableHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Track</th>
                  <th>Last Modified</th>
                  <th>Completion</th>
                  <th>Failures</th>
                  <th>Missing Components</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${songs
                  .map((song) => {
                    let badgeClass = 'low'
                    if (song.completion_status >= 75) badgeClass = 'high'
                    else if (song.completion_status >= 50) badgeClass = 'medium'

                    const missingItems =
                      song.missing_items || song.missing_components || []
                    const missingText =
                      Array.isArray(missingItems) && missingItems.length > 0
                        ? missingItems.join(', ')
                        : 'None'

                    const failureCount = song.failure_count || 0
                    const failureBadgeClass =
                      failureCount >= 3
                        ? 'low'
                        : failureCount >= 2
                        ? 'medium'
                        : 'high'

                    return `
                      <tr>
                        <td>${song.title || 'Unknown'} - ${
                      song.artist || 'Unknown'
                    }</td>
                        <td>${new Date(
                          song.last_modified
                        ).toLocaleString()}</td>
                        <td><span class="completion-badge ${badgeClass}">${
                      song.completion_status || 0
                    }%</span></td>
                        <td><span class="completion-badge ${failureBadgeClass}" title="${
                      song.error_message || 'No error message'
                    }">${failureCount}x</span></td>
                        <td>${missingText}</td>
                        <td>
                          <button class="reprocess-btn" onclick="reprocessTrack('${
                            song.track_id
                          }')" style="margin-right: 0.5rem;">
                            <i class="fas fa-redo"></i> Reprocess
                          </button>
                          ${
                            failureCount >= 2
                              ? `
                            <button class="delete-btn" onclick="deleteFailedTrack('${song.track_id}')" title="Delete this track permanently">
                              <i class="fas fa-trash"></i> Delete
                            </button>
                          `
                              : ''
                          }
                        </td>
                      </tr>
                    `
                  })
                  .join('')}
              </tbody>
            </table>
          </div>
        `

        container.innerHTML = tableHTML
      }

      async function reprocessTrack(trackId) {
        try {
          const response = await fetch('/admin/status/reprocess', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ track_id: trackId }),
          })

          if (response.ok) {
            showNotification('Track reprocessing started', 'success')
            fetchUnfinishedSongs()
          } else {
            throw new Error('Failed to reprocess track')
          }
        } catch (error) {
          showNotification(error.message, 'error')
        }
      }

      async function deleteFailedTrack(trackId) {
        if (
          !confirm(
            `Are you sure you want to permanently delete track ${trackId}? This action cannot be undone.`
          )
        ) {
          return
        }

        try {
          const response = await fetch(`/admin/track/${trackId}`, {
            method: 'DELETE',
            credentials: 'include',
          })

          const data = await response.json()

          if (response.ok) {
            showNotification('Track deleted successfully', 'success')
            fetchUnfinishedSongs()
          } else {
            throw new Error(data.error || 'Failed to delete track')
          }
        } catch (error) {
          showNotification(error.message, 'error')
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadUsers()
        loadInviteKeys()
      })
    </script>
  </body>
</html>
