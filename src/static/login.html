<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Sign in to MelodAI - AI-Powered Karaoke" />
    <title>Sign In - MelodAI</title>
    <link rel="icon" href="/logo.svg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/css/base.css" />
    <style>
      /* Login Page Specific Styles */
      .auth-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-4);
        background: linear-gradient(135deg, var(--background) 0%, color-mix(in srgb, var(--primary) 5%, var(--background)) 100%);
      }

      .auth-card {
        width: 100%;
        max-width: 420px;
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        padding: var(--space-8);
        opacity: 0;
        animation: fadeSlideUp 0.5s ease 0.3s forwards;
      }

      @keyframes fadeSlideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .auth-logo {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: var(--space-8);
      }

      .auth-logo img {
        width: 100px;
        height: 100px;
        margin-bottom: var(--space-4);
      }

      .auth-logo h1 {
        font-size: var(--text-2xl);
        color: var(--primary);
        margin: 0;
      }

      .auth-form {
        display: none;
      }

      .auth-form.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }

      .auth-title {
        text-align: center;
        font-size: var(--text-xl);
        margin-bottom: var(--space-6);
        color: var(--text);
      }

      .form-input-wrapper {
        position: relative;
      }

      .form-input-wrapper i {
        position: absolute;
        left: var(--space-4);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
      }

      .form-input-wrapper .form-input {
        padding-left: var(--space-10);
      }

      .form-actions {
        margin-top: var(--space-6);
      }

      .form-actions .btn {
        width: 100%;
        padding: var(--space-3);
      }

      .form-footer {
        text-align: center;
        margin-top: var(--space-6);
      }

      .form-link {
        color: var(--primary);
        cursor: pointer;
        font-size: var(--text-sm);
        transition: color var(--transition);
      }

      .form-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
      }

      .form-message {
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        font-weight: 500;
        margin-top: var(--space-4);
        display: none;
      }

      .form-message.show {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        animation: shake 0.5s ease;
      }

      .form-message.error {
        background: var(--badge-danger-bg);
        color: var(--badge-danger-text);
      }

      .form-message.success {
        background: var(--badge-success-bg);
        color: var(--badge-success-text);
      }

      .nav-links {
        position: fixed;
        top: var(--space-4);
        right: var(--space-4);
        display: flex;
        gap: var(--space-3);
        z-index: 100;
      }

      .theme-toggle-btn {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-full);
        background: var(--surface);
        border: none;
        color: var(--text);
        cursor: pointer;
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition);
      }

      .theme-toggle-btn:hover {
        background: var(--primary);
        color: white;
        transform: scale(1.05);
      }

      /* Form divider */
      .form-divider {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin: var(--space-4) 0;
        color: var(--text-muted);
        font-size: var(--text-sm);
      }

      .form-divider::before,
      .form-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      @media (max-width: 480px) {
        .auth-card {
          padding: var(--space-6);
        }

        .auth-logo img {
          width: 80px;
          height: 80px;
        }
      }
    </style>
  </head>
  <body>
    <div class="nav-links">
      <a href="/about" class="btn btn-ghost">
        <i class="fas fa-info-circle"></i>
        About
      </a>
      <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle theme">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>

    <main class="auth-page">
      <div class="auth-card">
        <div class="auth-logo">
          <img src="/logo.svg" alt="MelodAI" />
          <h1>MelodAI</h1>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="auth-form active">
          <h2 class="auth-title">Welcome back</h2>
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label class="form-label" for="loginUsername">Username</label>
              <div class="form-input-wrapper">
                <i class="fas fa-user"></i>
                <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" required autocomplete="username" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="loginPassword">Password</label>
              <div class="form-input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required autocomplete="current-password" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-checkbox">
                <input type="checkbox" id="rememberMe" />
                <span>Remember me for 30 days</span>
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-sign-in-alt"></i>
                Sign In
              </button>
            </div>
            <div id="loginMessage" class="form-message"></div>
          </form>
          <div class="form-footer">
            <span class="form-link" onclick="showForm('register')">Create an account</span>
            <span class="form-divider">or</span>
            <span class="form-link" onclick="showForm('forgot')">Forgot password?</span>
          </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="auth-form">
          <h2 class="auth-title">Create account</h2>
          <form onsubmit="handleRegister(event)">
            <div class="form-group">
              <label class="form-label" for="registerUsername">Username</label>
              <div class="form-input-wrapper">
                <i class="fas fa-user"></i>
                <input type="text" id="registerUsername" class="form-input" placeholder="Choose a username" required autocomplete="username" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="registerPassword">Password</label>
              <div class="form-input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="registerPassword" class="form-input" placeholder="Create a password" required autocomplete="new-password" oninput="validatePasswords()" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="confirmPassword">Confirm Password</label>
              <div class="form-input-wrapper">
                <i class="fas fa-lock"></i>
                <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password" required autocomplete="new-password" oninput="validatePasswords()" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label" for="inviteKey">Invite Key <span class="text-muted text-sm">(optional)</span></label>
              <div class="form-input-wrapper">
                <i class="fas fa-key"></i>
                <input type="text" id="inviteKey" class="form-input" placeholder="Enter invite key if you have one" />
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" id="registerButton" class="btn btn-primary btn-lg" disabled>
                <i class="fas fa-user-plus"></i>
                Create Account
              </button>
            </div>
            <div id="registerMessage" class="form-message"></div>
          </form>
          <div class="form-footer">
            <span class="form-link" onclick="showForm('login')">
              <i class="fas fa-arrow-left"></i> Back to sign in
            </span>
          </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotForm" class="auth-form">
          <h2 class="auth-title">Reset password</h2>
          <p class="text-muted text-center mb-6">Enter your username and we'll send you a reset link.</p>
          <form onsubmit="handleForgotPassword(event)">
            <div class="form-group">
              <label class="form-label" for="resetUsername">Username</label>
              <div class="form-input-wrapper">
                <i class="fas fa-user"></i>
                <input type="text" id="resetUsername" class="form-input" placeholder="Enter your username" required />
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane"></i>
                Send Reset Link
              </button>
            </div>
            <div id="forgotMessage" class="form-message"></div>
          </form>
          <div class="form-footer">
            <span class="form-link" onclick="showForm('login')">
              <i class="fas fa-arrow-left"></i> Back to sign in
            </span>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Theme Management
      function getTheme() {
        return localStorage.getItem('theme') || 'light';
      }

      function setTheme(theme) {
        localStorage.setItem('theme', theme);
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.getElementById('themeIcon');
        icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
      }

      function toggleTheme() {
        const newTheme = getTheme() === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
      }

      // Form Navigation
      function showForm(formName) {
        document.querySelectorAll('.auth-form').forEach(form => {
          form.classList.remove('active');
        });
        document.getElementById(formName + 'Form').classList.add('active');

        // Clear messages
        document.querySelectorAll('.form-message').forEach(msg => {
          msg.classList.remove('show');
        });
      }

      // Show Message
      function showMessage(elementId, message, isError = true) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = 'form-message show ' + (isError ? 'error' : 'success');
      }

      // Password Validation
      function validatePasswords() {
        const password = document.getElementById('registerPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        const btn = document.getElementById('registerButton');
        const messageEl = document.getElementById('registerMessage');

        if (!password || !confirm) {
          btn.disabled = true;
          messageEl.classList.remove('show');
          return;
        }

        if (password === confirm) {
          messageEl.textContent = 'Passwords match';
          messageEl.className = 'form-message show success';
          btn.disabled = false;
        } else {
          messageEl.textContent = 'Passwords do not match';
          messageEl.className = 'form-message show error';
          btn.disabled = true;
        }
      }

      // Login Handler
      async function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        try {
          const response = await fetch('/auth/login', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, remember_me: rememberMe }),
          });

          if (response.ok) {
            const redirect = new URLSearchParams(window.location.search).get('redirect') || '/';
            window.location.href = redirect;
          } else {
            const data = await response.json();
            showMessage('loginMessage', data.error || 'Invalid credentials');
          }
        } catch (error) {
          showMessage('loginMessage', 'An error occurred. Please try again.');
        }
      }

      // Register Handler
      async function handleRegister(e) {
        e.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const inviteKey = document.getElementById('inviteKey').value;

        try {
          const response = await fetch('/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, invite_key: inviteKey }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage('registerMessage', data.message, false);
            if (data.auto_login) {
              setTimeout(() => window.location.href = '/', 1000);
            } else {
              setTimeout(() => showForm('login'), 2000);
            }
          } else {
            showMessage('registerMessage', data.error);
          }
        } catch (error) {
          showMessage('registerMessage', 'An error occurred. Please try again.');
        }
      }

      // Forgot Password Handler
      async function handleForgotPassword(e) {
        e.preventDefault();
        const username = document.getElementById('resetUsername').value;

        try {
          const response = await fetch('/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username }),
          });

          const data = await response.json();

          if (response.ok) {
            showMessage('forgotMessage', data.message, false);
          } else {
            showMessage('forgotMessage', data.error);
          }
        } catch (error) {
          showMessage('forgotMessage', 'An error occurred. Please try again.');
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        setTheme(getTheme());
      });
    </script>
  </body>
</html>
