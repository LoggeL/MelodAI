<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MelodAI</title>
    <link rel="icon" href="/logo.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #0ea5e9;
        --success: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --background: #f8fafc;
        --surface: #ffffff;
        --text: #1e293b;
        --text-light: #64748b;
        --border: #6366f1;
        --hover: #f1f5f9;
      }

      /* Dark theme */
      [data-theme='dark'] {
        --primary: #818cf8;
        --primary-dark: #6366f1;
        --secondary: #38bdf8;
        --success: #4ade80;
        --danger: #f87171;
        --warning: #fbbf24;
        --background: #0f172a;
        --surface: #1e293b;
        --text: #f1f5f9;
        --text-light: #94a3b8;
        --border: #334155;
        --hover: #334155;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 20px;
        background: var(--background);
        color: var(--text);
        display: flex;
        gap: 20px;
        height: 100vh;
        overflow: hidden;
      }

      /* Mobile improvements */
      @media (max-width: 768px) {
        body {
          padding: 10px;
          gap: 10px;
        }

        .side-container {
          height: calc(100vh - 40px) !important;
          max-height: calc(100vh - 40px) !important;
          padding: 10px !important;
        }

        .lyrics-container {
          height: calc(100vh - 20px) !important;
        }

        .only-on-small {
          display: block;
        }
      }

      body.collapsed {
        gap: 0;
      }

      .side-container {
        background: var(--surface);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        max-height: calc(100vh - 80px);
        overflow-y: auto;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        max-width: 400px;
        transition: max-width 0.3s, opacity 0.3s, padding 0.3s;
      }

      body.collapsed .side-container {
        max-width: 0;
        opacity: 0;
        padding: 0;
      }

      .search-container {
        position: relative;
        margin-bottom: 20px;
      }

      .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        padding: 20px;
      }

      .logo-container img {
        width: 37.5%;
      }

      .search-input {
        width: calc(100% - 24px);
        padding: 10px;
        border-radius: 4px;
        border: 2px solid var(--border);
        margin-bottom: 10px;
      }

      .search-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
      }

      .search-dropdown.active {
        display: block;
      }

      .search-result {
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }

      .search-result:hover {
        background: var(--hover);
      }

      .search-result img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        object-fit: cover;
      }

      .queue-item {
        padding: 10px;
        margin: 5px 0;
        background: var(--background);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background-color 0.2s;
        position: relative;
      }

      .queue-item.error {
        background: var(--danger);
        cursor: not-allowed;
      }

      .queue-item:hover {
        background: var(--hover);
      }

      .queue-item.active {
        background: var(--primary);
        color: white;
      }

      .queue-item img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
      }

      .controls {
        background: var(--surface);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .progress {
        height: 10px;
        background: var(--primary);
        border-radius: 4px;
        width: 0;
        transition: width 0.1s;
      }

      .progress-bar {
        background: var(--background);
        border-radius: 4px;
        margin-top: 10px;
        cursor: pointer;
      }

      .progress-time {
        display: flex;
        margin-bottom: 10px;
      }

      .thumbnail {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .volume-controls {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }

      .lyrics-container {
        flex: 1;
        padding: 0;
        overflow-y: auto;
        background: var(--surface);
        border-radius: 8px;
        min-height: 0;
        height: calc(100vh - 40px);
        position: relative;
        min-height: 200px;
        scroll-behavior: smooth;
        scrollbar-gutter: stable;
      }

      .lyrics-skeleton {
        padding: calc(50vh - 100px) 0;
        box-sizing: border-box;
      }

      .skeleton-line {
        height: 24px;
        background: linear-gradient(
          90deg,
          var(--hover) 25%,
          var(--surface) 50%,
          var(--hover) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
        margin: 8px 0;
      }

      .skeleton-line:nth-child(4n) {
        width: 100%;
      }

      .skeleton-line:nth-child(4n + 2) {
        width: 85%;
      }
      .skeleton-line:nth-child(4n + 3) {
        width: 70%;
      }
      .skeleton-line:nth-child(4n + 4) {
        width: 90%;
      }

      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      .lyrics {
        font-size: 1.5rem;
        line-height: 1.6;
        margin: 2rem 0;
        min-height: 200px;
      }

      .lyrics.loading {
        display: none;
      }

      .lyrics-line {
        margin: 20px 0;
        padding: 10px;
        padding-left: 16px;
        border-radius: 8px;
        transition: all 0.5s ease;
        opacity: 0;
        background: color-mix(in srgb, var(--primary), var(--surface) 95%);
      }

      .lyrics-line.active {
        background: color-mix(in srgb, var(--primary), var(--surface) 50%);
        opacity: 1;
      }

      .word {
        display: inline-block;
        margin-right: 5px;
        padding: 2px 4px;
        border-radius: 4px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .word:hover {
        background: color-mix(in srgb, var(--primary), transparent 85%);
      }

      .word.active {
        background: color-mix(in srgb, var(--warning), white 70%);
      }

      /* Speaker colors */
      .speaker-SPEAKER_00 {
        border-left: 6px solid #22d3ee;
      }

      .speaker-SPEAKER_01 {
        border-left: 6px solid #f472b6;
      }

      .speaker-SPEAKER_02 {
        border-left: 6px solid #34d399;
      }

      .speaker-SPEAKER_03 {
        border-left: 6px solid #fbbf24;
      }

      .speaker-SPEAKER_04 {
        border-left: 6px solid #818cf8;
      }

      .speaker-SPEAKER_05 {
        border-left: 6px solid #fb7185;
      }

      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: var(--primary);
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background: var(--primary-dark);
      }

      .now-playing {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .button-container {
        display: flex;
        gap: 10px;
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
      }

      .profile-container {
        position: relative;
      }

      .profile-button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: var(--hover);
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: var(--text);
        transition: background-color 0.2s;
      }

      .profile-button:hover {
        background: var(--border);
        color: var(--surface);
      }

      .profile-button i {
        font-size: 1.2rem;
      }

      .profile-button .profile-initial {
        display: none;
      }

      .profile-dropdown.active {
        display: block;
      }

      .profile-dropdown-item {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        color: var(--text);
        text-decoration: none;
      }

      .profile-dropdown-item:hover {
        background: var(--hover);
      }

      .profile-dropdown-item i {
        width: 20px;
        text-align: center;
      }

      .profile-dropdown hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 0.5rem 0;
      }

      /* Add this theme toggle button style */
      .theme-toggle {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text);
      }

      .theme-toggle:hover {
        background: var(--hover);
      }

      /* Add smooth transitions for theme changes */
      * {
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      }

      /* Dark mode specific adjustments */
      [data-theme='dark'] .auth-container {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      }

      [data-theme='dark'] .card {
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      }

      [data-theme='dark'] input {
        background: var(--background);
        color: var(--text);
      }

      [data-theme='dark'] .search-result:hover {
        background: var(--hover);
      }

      [data-theme='dark'] .lyrics-line.active {
        background: color-mix(in srgb, var(--primary), var(--surface) 70%);
      }

      [data-theme='dark'] .word.active {
        background: color-mix(in srgb, var(--warning), var(--surface) 70%);
      }

      [data-theme='dark'] .status-pending {
        background: color-mix(in srgb, var(--warning), var(--surface) 80%);
      }

      [data-theme='dark'] .status-approved {
        background: color-mix(in srgb, var(--success), var(--surface) 80%);
      }

      /* Dark mode speaker colors */
      [data-theme='dark'] .speaker-SPEAKER_00 {
        border-left: 6px solid #06b5d4;
      }
      [data-theme='dark'] .speaker-SPEAKER_01 {
        border-left: 6px solid #ec4899;
      }
      [data-theme='dark'] .speaker-SPEAKER_02 {
        border-left: 6px solid #10b981;
      }
      [data-theme='dark'] .speaker-SPEAKER_03 {
        border-left: 6px solid #d97706;
      }
      [data-theme='dark'] .speaker-SPEAKER_04 {
        border-left: 6px solid #6366f1;
      }
      [data-theme='dark'] .speaker-SPEAKER_05 {
        border-left: 6px solid #e11d48;
      }

      .queue-status {
        font-size: 0.7em;
        color: var(--text-light);
        margin-top: 2px;
      }

      .progress-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--primary);
        transition: width 0.3s ease;
      }

      .lyrics-header {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 1rem;
        position: sticky;
        top: 0;
        background: var(--surface);
        z-index: 10;
      }

      .lyrics-title-container {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .lyrics-profile {
        margin-left: auto;
        position: relative;
      }

      .lyrics-profile .profile-button {
        width: 36px;
        height: 36px;
      }

      .profile-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        display: none;
        min-width: 200px;
        z-index: 1000;
      }

      .lyrics-cover {
        width: 64px;
        height: 64px;
        object-fit: cover;
      }

      .lyrics-artist {
        color: var(--text-light);
        font-size: 0.9rem;
        margin-bottom: 4px;
      }

      .lyrics-title {
        margin: 0;
        color: var(--text);
        font-size: 1.5rem;
      }

      .player-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        align-items: center;
        margin: 1rem 0;
      }

      .control-btn {
        background: none;
        border: none;
        color: var(--text);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .control-btn:disabled:hover {
        background: none;
      }

      .control-btn:hover {
        background: var(--hover);
      }

      .control-btn.active {
        color: var(--primary);
      }

      .control-btn.muted {
        color: var(--danger);
      }

      .play-btn {
        font-size: 1.75rem;
        min-width: 48px;
        height: 48px;
        background: var(--primary);
        color: white;
      }

      .play-btn:hover {
        background: var(--primary-dark);
      }

      .download-dropdown {
        position: absolute;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 1000;
      }

      .download-dropdown.active {
        display: block;
      }

      .download-option {
        padding: 10px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .download-option:hover {
        background: var(--hover);
      }

      /* Dark mode adjustments */
      [data-theme='dark'] .download-dropdown {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      /* Toast notification styles */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface);
        color: var(--text);
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .toast.active {
        opacity: 1;
      }

      .toast i {
        color: var(--success);
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--text) 20%, transparent);
        border-radius: 4px;
        transition: background 0.2s;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: color-mix(in srgb, var(--text) 30%, transparent);
      }

      /* Firefox scrollbar styling */
      * {
        scrollbar-width: thin;
        scrollbar-color: color-mix(in srgb, var(--text) 20%, transparent)
          transparent;
      }

      /* Hide scrollbar when not hovering */
      .lyrics-container {
        scrollbar-gutter: stable;
      }

      .lyrics-container:not(:hover)::-webkit-scrollbar-thumb {
        background: transparent;
      }

      /* Dark mode scrollbar adjustments */
      [data-theme='dark'] ::-webkit-scrollbar-thumb {
        background: color-mix(in srgb, var(--text) 15%, transparent);
      }

      [data-theme='dark'] ::-webkit-scrollbar-thumb:hover {
        background: color-mix(in srgb, var(--text) 25%, transparent);
      }

      /* Update the lyrics-content style */
      .lyrics-content {
        /* Add padding equal to half the container height */
        padding: calc(50vh - 100px) 0;
        /* Ensure the padding is included in scrolling */
        box-sizing: border-box;
      }

      /* Update the lyrics-line style */
      .lyrics-line {
        margin: 20px 10px;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.5s ease;
        opacity: 0;
      }

      /* Update the lyrics-container style */
      .lyrics-container {
        flex: 1;
        padding: 0;
        overflow-y: auto;
        background: var(--surface);
        border-radius: 8px;
        min-height: 0;
        height: calc(100vh - 40px);
        position: relative;
        min-height: 200px;
        /* Add smooth scrolling */
        scroll-behavior: smooth;
        /* Ensure proper scrollbar positioning */
        scrollbar-gutter: stable;
      }

      /* Add styles for the lyrics skeleton to maintain centering */
      .lyrics-skeleton {
        padding: calc(50vh - 100px) 0;
        box-sizing: border-box;
      }

      /* Update the initial message styling */
      .lyrics-content h2 {
        /* Center the initial message vertically */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        margin: 0;
        /* Add some styling */
        color: var(--text-light);
        font-weight: normal;
      }

      .word.active {
        background: color-mix(in srgb, var(--warning), white 70%);
      }

      [data-theme='dark'] .word.active {
        background: color-mix(in srgb, var(--warning), var(--surface) 70%);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  </head>

  <body>
    <div class="side-container">
      <!-- Search -->
      <button
        class="control-btn only-on-small"
        onclick="toggleMenu()"
        aria-label="Toggle menu"
      >
        <i class="fas fa-bars"></i>
      </button>
      <div class="search-container">
        <div class="logo-container">
          <img src="/logo.svg" alt="logo" class="logo" />
        </div>
        <input
          type="text"
          class="search-input"
          placeholder="Search for a song..."
        />
        <div class="search-dropdown" id="searchDropdown"></div>
      </div>
      <div class="controls">
        <div class="now-playing" id="nowPlaying">Select a song to begin</div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
        <div class="progress-time">
          <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
        </div>
        <div class="player-controls">
          <button class="control-btn play-btn" id="playButton">
            <i class="fas fa-play"></i>
          </button>
          <button class="control-btn" id="randomSong">
            <i class="fas fa-dice"></i>
          </button>
          <button class="control-btn" id="toggleFullscreen">
            <i class="fas fa-expand"></i>
          </button>
          <button
            class="control-btn"
            id="downloadButton"
            title="Download"
            disabled
          >
            <i class="fas fa-download"></i>
          </button>
          <button class="control-btn" id="shareSong" title="Share" disabled>
            <i class="fas fa-share-alt"></i>
          </button>
        </div>

        <div class="volume-controls">
          <label>Vocals:</label>
          <input
            type="range"
            id="vocalsVolume"
            min="0"
            max="1"
            step="0.1"
            value="0.5"
          />
        </div>
        <div class="volume-controls">
          <label>Music:</label>
          <input
            type="range"
            id="musicVolume"
            min="0"
            max="1"
            step="0.1"
            value="0.5"
          />
        </div>
      </div>
      <h2>Song Queue</h2>
      <div id="songQueue"></div>
    </div>

    <div class="lyrics-container" id="lyricsContainer">
      <div class="lyrics-header">
        <button
          class="control-btn"
          onclick="toggleMenu()"
          aria-label="Toggle menu"
        >
          <i class="fas fa-bars"></i>
        </button>
        <div class="lyrics-title-container">
          <img class="lyrics-cover" src="/logo.svg" alt="Album cover" />
          <div class="lyrics-info">
            <div class="lyrics-title"></div>
            <div class="lyrics-artist"></div>
          </div>
          <div class="lyrics-profile">
            <button class="profile-button" id="profileButton">
              <i class="fas fa-user"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <div class="profile-dropdown-item" id="profileName">
                <i class="fas fa-user"></i>
                <span>Loading...</span>
              </div>
              <hr />
              <div
                class="profile-dropdown-item"
                id="darkModeButton"
                onclick="toggleTheme()"
              >
                <i class="fas fa-moon"></i>
                Dark Mode
              </div>
              <div
                class="profile-dropdown-item"
                id="adminButton"
                style="display: none"
                onclick="window.location.href='/admin'"
              >
                <i class="fas fa-shield-alt"></i>
                Admin Panel
              </div>
              <hr />
              <div class="profile-dropdown-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="lyrics-content">
        <h2>Select a song to start</h2>
      </div>
    </div>

    <div class="download-dropdown" id="downloadDropdown">
      <div class="download-option" id="downloadVocals">
        <i class="fas fa-microphone"></i> Download Vocals
      </div>
      <div class="download-option" id="downloadMusic">
        <i class="fas fa-music"></i> Download Music
      </div>
      <div class="download-option" id="downloadFull">
        <i class="fas fa-compact-disc"></i> Download Full Song
      </div>
    </div>

    <script>
      class KaraokePlayer {
        constructor() {
          this.vocalsAudio = new Audio()
          this.musicAudio = new Audio()
          this.lyrics = null
          this.playing = false
          this.currentWordIndex = 0
          this.currentSongIndex = -1
          this.hasUserInteracted = false

          // Add event listener for first interaction
          document.addEventListener(
            'click',
            () => {
              this.hasUserInteracted = true
            },
            { once: true }
          )

          // Ensure buttons are disabled initially
          document.getElementById('downloadButton').disabled = true
          document.getElementById('shareSong').disabled = true

          this.socket = io('')
          this.setupSocketListeners()

          // Sample song queue (in real app, this might come from an API)
          this.songQueue = []

          this.setupControls()
          this.renderQueue()

          // Add click handler for lyrics words
          document.addEventListener('click', (e) => {
            if (e.target.classList.contains('word')) {
              const startTime = parseFloat(e.target.dataset.start)
              if (!isNaN(startTime)) {
                this.jumpToTime(startTime)
              }
            }
          })
        }

        setupSocketListeners() {
          this.socket.on('track_ready', (data) => {
            const song = this.songQueue.find((s) => s.id == data.track_id)
            if (song) {
              song.ready = true
              song.status = ''
              this.updateQueue()
              console.log('track_ready', data)
            }
          })

          this.socket.on('track_progress', (data) => {
            const song = this.songQueue.find((s) => s.id == data.track_id)
            if (song) {
              song.ready = song.progress < 100 ? false : true
              song.progress = data.progress
              song.status = data.status
              this.updateQueue()
            }
          })

          this.socket.on('track_error', (data) => {
            const song = this.songQueue.find((s) => s.id == data.track_id)
            if (song) {
              song.status = data.error
              song.error = true
              this.updateQueue()
            }
          })
        }

        async loadLyrics(lyricsUrl) {
          try {
            // Clear lyrics
            this.lyrics = null
            document.querySelector('.lyrics-cover').src = '/logo.svg'
            document.querySelector('.lyrics-content').innerHTML = `
            <div class="lyrics-skeleton">
              ${Array.from({ length: 30 })
                .map(() => '<div class="skeleton-line"></div>')
                .join('')}
            </div>
            `

            const response = await fetch(lyricsUrl)
            if (!response.ok) {
              throw new Error('Failed to load lyrics')
            }
            const data = await response.json()

            // Iterate through the segments / words and split if the speaker changes
            let segments = []
            data.segments.forEach((segment) => {
              let currentSegment = {
                start: segment.start,
                end: segment.end,
                words: [],
              }
              let currentSpeaker = segment.words[0].speaker
              segment.words.forEach((word, i) => {
                let nextWord =
                  i < segment.words.length - 1 ? segment.words[i + 1] : word
                if (
                  word.speaker &&
                  currentSpeaker &&
                  word.speaker !== currentSpeaker &&
                  nextWord.speaker === word.speaker
                ) {
                  segments.push(currentSegment)
                  currentSegment = {
                    start: word.start,
                    end: word.end,
                    words: [],
                  }
                  currentSpeaker = word.speaker
                } else {
                  currentSpeaker = word.speaker
                }
                currentSegment.words.push(word)
              })
              segments.push(currentSegment)
            })

            this.lyrics = segments
            setTimeout(() => this.renderLyrics(), 1000)
            // this.renderLyrics()
          } catch (error) {
            console.error('Error loading lyrics:', error)
          }
        }

        renderLyrics() {
          if (!this.lyrics) return

          const lyrics = document.querySelector('.lyrics-content')
          lyrics.innerHTML = ''

          const song = this.songQueue[this.currentSongIndex]

          // Update cover art
          const cover = document.querySelector('.lyrics-cover')
          cover.src = song.thumbnail

          const artist = document.querySelector('.lyrics-artist')
          const title = document.querySelector('.lyrics-title')

          artist.textContent = song.artist
          title.textContent = song.title

          this.lyrics.forEach((segment, segmentIndex) => {
            const lineDiv = document.createElement('div')
            lineDiv.classList.add('lyrics-line', 'speaker')
            lineDiv.id = `line-${segmentIndex}`

            // Get unique speakers and add speaker classes
            const speakers = new Set(segment.words.map((word) => word.speaker))
            speakers.forEach((speaker) => {
              if (speaker) lineDiv.classList.add(`speaker-${speaker}`)
            })

            segment.words.forEach((word, wordIndex) => {
              const wordSpan = document.createElement('span')
              wordSpan.classList.add('word')
              wordSpan.id = `word-${segmentIndex}-${wordIndex}`
              wordSpan.dataset.start = word.start
              wordSpan.dataset.end = word.end
              wordSpan.textContent = word.word

              // Add space after each word except the last one
              if (wordIndex < segment.words.length - 1) {
                lineDiv.appendChild(wordSpan)
                lineDiv.appendChild(document.createTextNode(' '))
              } else {
                lineDiv.appendChild(wordSpan)
              }
            })

            lyrics.appendChild(lineDiv)
          })

          // Only autoplay if user has interacted with the page
          if (this.hasUserInteracted) {
            document.getElementById('playButton').click()
          }

          // Scroll to the first line
          const firstLine = document.querySelector('.lyrics-line')
          if (firstLine) {
            firstLine.scrollIntoView({
              behavior: 'smooth',
              block: 'center',
            })
          }
        }

        jumpToTime(time) {
          this.vocalsAudio.currentTime = time
          this.musicAudio.currentTime = time

          // Start playing if not already playing
          if (!this.playing) {
            this.togglePlay()
          }
        }

        clickProgressBar(e) {
          const rect = e.target.getBoundingClientRect()
          const x = e.clientX - rect.left
          const width = rect.width
          const progress = x / width
          const time = progress * this.vocalsAudio.duration
          this.jumpToTime(time)
        }

        startLyricsSync() {
          const checkTime = () => {
            if (!this.playing) return

            const currentTime = this.vocalsAudio.currentTime

            // Update progress bar
            const progress = (currentTime / this.vocalsAudio.duration) * 100
            document.getElementById('progress').style.width = `${progress}%`

            // Update current time
            const minutes = Math.floor(currentTime / 60)
            const seconds = Math.floor(currentTime % 60)
            document.getElementById(
              'currentTime'
            ).textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`

            // Get the next lyrics block as active
            let currentIndex = 0
            for (let i = 0; i < this.lyrics.length; i++) {
              const lyricsLine = this.lyrics[i]
              if (lyricsLine.start > currentTime) {
                currentIndex = i
                break
              }
            }

            // Reset all word highlights
            document.querySelectorAll('.word.active').forEach((word) => {
              word.classList.remove('active')
            })

            // Reset all line highlights
            document.querySelectorAll('.lyrics-line.active').forEach((line) => {
              line.classList.remove('active')
            })

            // Find and highlight the current word
            this.lyrics.forEach((segment) => {
              segment.words.forEach((word) => {
                if (currentTime >= word.start && currentTime <= word.end) {
                  const wordElement = document.querySelector(
                    `[data-start="${word.start}"]`
                  )
                  if (wordElement) {
                    wordElement.classList.add('active')
                  }
                }
              })
            })

            this.lyrics.forEach((segment, segmentIndex) => {
              const lineElement = document.getElementById(
                `line-${segmentIndex}`
              )

              const timeDiff = segment.start - currentTime
              const indexDiff =
                Math.max(0, 5 - Math.abs(segmentIndex - currentIndex)) / 5

              if (currentTime >= segment.start && currentTime <= segment.end) {
                lineElement.classList.add('active')
                lineElement.scrollIntoView({
                  behavior: 'smooth',
                  block: 'center',
                })
                lineElement.style.opacity = 1
              } else if (timeDiff > 0) {
                const opacity = Math.max(
                  Math.max(0.1, (20 - timeDiff) / 20),
                  indexDiff
                )
                lineElement.style.opacity = opacity
              } else {
                const pastDiff = Math.abs(segment.end - currentTime)
                const opacity = Math.max(
                  Math.max(0.1, (20 - pastDiff) / 20),
                  indexDiff
                )
                lineElement.style.opacity = opacity
              }
            })

            requestAnimationFrame(checkTime)
          }

          requestAnimationFrame(checkTime)
        }

        async loadSong(index) {
          console.log('loadSong', index)
          if (index === null || index < 0 || index >= this.songQueue.length)
            return

          this.currentSongIndex = index
          const song = this.songQueue[index]

          // Enable download and share buttons
          document.getElementById('downloadButton').disabled = false
          document.getElementById('shareSong').disabled = false

          // Update URL hash with current song ID
          window.location.hash = `song=${song.id}`

          this.updateQueueHighlight()

          // Update UI elements
          document.getElementById(
            'nowPlaying'
          ).textContent = `Now Playing: ${song.title}`

          // Reset player state
          this.playing = false
          this.vocalsAudio.src = song.vocalsUrl
          this.musicAudio.src = song.musicUrl
          document
            .querySelector('#playButton i')
            .classList.replace('fa-pause', 'fa-play')

          // Update total time
          this.vocalsAudio.onloadedmetadata = () => {
            const minutes = Math.floor(this.vocalsAudio.duration / 60)
            const seconds = Math.floor(this.vocalsAudio.duration % 60)
            document.getElementById(
              'totalTime'
            ).textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`

            // Reset progress bar
            document.getElementById('progress').style.width = '0'
          }

          // Load lyrics
          this.loadLyrics(song.lyricsUrl)
        }

        renderQueue() {
          const queueContainer = document.getElementById('songQueue')
          queueContainer.innerHTML = this.songQueue
            .map(
              (song, index) => `
                  <div id="queue-${song.id}"
                       class="queue-item ${
                         index === this.currentSongIndex ? 'active' : ''
                       }">
                      <img src="${song.thumbnail}" alt="${song.title}">
                      <div>
                          <div>${song.title}</div>
                          <div style="font-size: 0.8em">${song.artist}</div>
                          <div class="queue-status">${this.getStatus(
                            song
                          )}</div>
                      </div>
                      <div class="progress-overlay" style="width: ${
                        song.progress || 0
                      }%"></div>
                  </div>
              `
            )
            .join('')
          this.updateQueue()
        }

        getStatus(song) {
          if (!song.status) return ''

          const statusMap = {
            starting: 'Starting...',
            downloading: 'Downloading...',
            downloaded: 'Downloaded',
            splitting: 'Splitting audio...',
            extracting_lyrics: 'Extracted lyrics...',
            lyrics_extracted: 'Lyrics extracted...',
            chunking_lyrics: 'Chunking lyrics...',
            merging_lyrics: 'Merging lyrics...',
            lyrics_complete: 'Lyrics complete',
            error: 'Error processing track',
          }

          return statusMap[song.status] || song.status
        }

        updateQueue() {
          this.songQueue.forEach((song, index) => {
            const queueItem = document.getElementById(`queue-${song.id}`)
            if (queueItem) {
              queueItem.style.opacity = song.ready ? 1 : 0.7
              queueItem.style.cursor = song.ready ? 'pointer' : 'not-allowed'
              queueItem.style.cursor = song.error
                ? 'not-allowed'
                : queueItem.style.cursor

              if (index === this.currentSongIndex) {
                queueItem.classList.add('active')
              } else {
                queueItem.classList.remove('active')
              }

              // onclick if ready and doesn't already exist
              if (song.ready && !queueItem.onclick) {
                queueItem.onclick = () => this.loadSong(index)
              }

              if (song.error) {
                queueItem.classList.add('error')
              } else {
                queueItem.classList.remove('error')
              }

              // Update status and progress
              const statusDiv = queueItem.querySelector('.queue-status')
              if (statusDiv) {
                statusDiv.innerText = this.getStatus(song)
              }

              // Update progress bar
              const existingProgress =
                queueItem.querySelector('.progress-overlay')
              if (existingProgress) {
                existingProgress.style.width = `${song.progress || 0}%`
              }
            }
          })
        }

        updateQueueHighlight() {
          console.log('updateQueueHighlight', this.currentSongIndex)
          if (this.currentSongIndex === -1) return
          const items = document.querySelectorAll('.queue-item')
          items.forEach((item) => {
            item.classList.remove('active')
          })
          items[this.currentSongIndex].classList.add('active')
        }

        setupControls() {
          document
            .getElementById('playButton')
            .addEventListener('click', () => this.togglePlay())
          document
            .getElementById('randomSong')
            .addEventListener('click', () => this.randomSong())
          document
            .getElementById('toggleFullscreen')
            .addEventListener('click', () => this.toggleFullscreen())

          document
            .getElementById('vocalsVolume')
            .addEventListener('input', (e) => {
              this.vocalsAudio.volume = e.target.value
            })

          document
            .getElementById('musicVolume')
            .addEventListener('input', (e) => {
              this.musicAudio.volume = e.target.value
            })

          // Keep audio tracks synchronized
          this.vocalsAudio.addEventListener('play', () =>
            this.musicAudio.play()
          )
          this.vocalsAudio.addEventListener('pause', () =>
            this.musicAudio.pause()
          )
          this.vocalsAudio.addEventListener('ended', () => this.nextSong())

          // Setup download button
          const downloadButton = document.getElementById('downloadButton')
          const downloadDropdown = document.getElementById('downloadDropdown')

          downloadButton.addEventListener('click', (e) => {
            e.stopPropagation()
            const rect = downloadButton.getBoundingClientRect()
            downloadDropdown.style.top = `${rect.bottom + 5}px`
            downloadDropdown.style.left = `${rect.left}px`
            downloadDropdown.classList.toggle('active')
          })

          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            downloadDropdown.classList.remove('active')
          })

          // Setup download options
          document
            .getElementById('downloadVocals')
            .addEventListener('click', () => this.downloadTrack('vocals'))
          document
            .getElementById('downloadMusic')
            .addEventListener('click', () => this.downloadTrack('music'))
          document
            .getElementById('downloadFull')
            .addEventListener('click', () => this.downloadTrack('full'))

          // Setup share button
          document
            .getElementById('shareSong')
            .addEventListener('click', () => this.shareSong())
        }

        togglePlay() {
          if (this.currentSongIndex === -1) return

          if (this.playing) {
            this.vocalsAudio.pause()
            this.playing = false
            document
              .querySelector('#playButton i')
              .classList.replace('fa-pause', 'fa-play')
          } else {
            this.vocalsAudio.play()
            this.playing = true
            this.startLyricsSync()
            document
              .querySelector('#playButton i')
              .classList.replace('fa-play', 'fa-pause')
          }
        }

        previousSong() {
          if (this.currentSongIndex > 0) {
            this.loadSong(this.currentSongIndex - 1)
          }
        }

        nextSong() {
          if (this.currentSongIndex < this.songQueue.length - 1) {
            this.loadSong(this.currentSongIndex + 1)
          }
        }

        handleSearch(e) {
          // check if enter key is pressed
          if (e.key !== 'Enter') return

          const query = e.target.value

          const dropdown = document.getElementById('searchDropdown')
          if (query.length < 2) {
            dropdown.classList.remove('active')
            return
          }
          fetch('/search?q=' + query)
            .then((response) => response.json())
            .then((data) => {
              // Show results
              dropdown.innerHTML = data
                .map(
                  (song) => `
                    <div class="search-result" onclick="karaokePlayer.addToQueue(${song.id})">
                        <img src="${song.thumb}" alt="${song.title}">
                        <div>
                            <div><strong>${song.title}</strong></div>
                            <div style="font-size: 0.8em; color: #666;">${song.artist}</div>
                        </div>
                    </div>
                `
                )
                .join('')

              dropdown.classList.add('active')
            })
        }

        async addToQueue(id) {
          if (this.songQueue.some((item) => item.id === id)) {
            return alert('Song is already in the queue')
          }

          const song = await fetch(`/track/${id}`)
          const songData = await song.json()

          this.songQueue.push({
            id: id,
            title: songData.title,
            artist: songData.artist,
            thumbnail: `https://cdn-images.dzcdn.net/images/cover/${songData.cover}/56x56-000000-80-0-0.jpg`,
            vocalsUrl: 'songs/' + id + '/vocals.mp3',
            musicUrl: 'songs/' + id + '/no_vocals.mp3',
            lyricsUrl: 'songs/' + id + '/lyrics.json',
            ready: false,
            progress: 0,
            status: 'downloading',
          })

          this.renderQueue()
          document.getElementById('searchDropdown').classList.remove('active')
          document.querySelector('.search-input').value = ''

          fetch('/add?id=' + id)
            .then((response) => response.json())
            .catch((error) => {
              console.error('Error adding track:', error)
            })
        }

        async randomSong() {
          try {
            // Get all track IDs currently in the queue
            const queueIds = this.songQueue.map((song) => song.id)

            const response = await fetch('/random', {
              method: 'POST', // Changed to POST to send data
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                exclude_ids: queueIds,
              }),
            })
            const data = await response.json()

            if (response.ok) {
              this.songQueue.push({
                id: data.track_id,
                title: data.metadata.title,
                artist: data.metadata.artist,
                thumbnail: `https://e-cdns-images.dzcdn.net/images/cover/${data.metadata.cover}/250x250-000000-80-0-0.jpg`,
                vocalsUrl: `songs/${data.track_id}/vocals.mp3`,
                musicUrl: `songs/${data.track_id}/no_vocals.mp3`,
                lyricsUrl: `songs/${data.track_id}/lyrics.json`,
                ready: true,
                progress: 100,
                status: '',
              })

              this.renderQueue()
              // Load and play the random song immediately
              this.loadSong(this.songQueue.length - 1)
            } else {
              console.error('Error getting random song:', data.error)
            }
          } catch (error) {
            console.error('Error:', error)
          }
        }

        toggleFullscreen() {
          const i = document.querySelector('#toggleFullscreen i')
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen()
            i.classList.replace('fa-expand', 'fa-compress')
          } else {
            document.exitFullscreen()
            i.classList.replace('fa-compress', 'fa-expand')
          }
        }

        async downloadTrack(type) {
          if (this.currentSongIndex === -1) return

          const song = this.songQueue[this.currentSongIndex]
          let filename, url

          switch (type) {
            case 'vocals':
              filename = `${song.artist} - ${song.title} (vocals).mp3`
              url = song.vocalsUrl
              break
            case 'music':
              filename = `${song.artist} - ${song.title} (instrumental).mp3`
              url = song.musicUrl
              break
            case 'full':
              filename = `${song.artist} - ${song.title}.mp3`
              url = `songs/${song.id}/song.mp3`
              break
          }

          try {
            const response = await fetch(url)
            const blob = await response.blob()
            const downloadUrl = window.URL.createObjectURL(blob)

            const a = document.createElement('a')
            a.href = downloadUrl
            a.download = filename
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            window.URL.revokeObjectURL(downloadUrl)

            this.showToast('Download started', 'fa-check')
          } catch (error) {
            console.error('Download failed:', error)
            this.showToast('Download failed', 'fa-times')
          }
        }

        shareSong() {
          if (this.currentSongIndex === -1) return

          const song = this.songQueue[this.currentSongIndex]
          const url = `${window.location.origin}/#song=${song.id}`

          navigator.clipboard
            .writeText(url)
            .then(() => {
              this.showToast('Link copied to clipboard', 'fa-check')
            })
            .catch((error) => {
              console.error('Failed to copy link:', error)
              this.showToast('Failed to copy link', 'fa-times')
            })
        }

        showToast(message, icon) {
          const toast = document.createElement('div')
          toast.className = 'toast'
          toast.innerHTML = `
            <i class="fas ${icon}"></i>
            ${message}
          `
          document.body.appendChild(toast)

          // Trigger reflow to enable transition
          toast.offsetHeight

          toast.classList.add('active')

          setTimeout(() => {
            toast.classList.remove('active')
            setTimeout(() => {
              document.body.removeChild(toast)
            }, 300)
          }, 3000)
        }
      }

      // Initialize the player when the page loads
      let karaokePlayer
      window.addEventListener('DOMContentLoaded', () => {
        karaokePlayer = new KaraokePlayer()
        document
          .querySelector('.progress-bar')
          .addEventListener('click', (e) => karaokePlayer.clickProgressBar(e))
        document
          .querySelector('.search-input')
          .addEventListener('keyup', karaokePlayer.handleSearch)

        // Setup profile dropdown
        const profileButton = document.getElementById('profileButton')
        const profileDropdown = document.getElementById('profileDropdown')

        profileButton.addEventListener('click', (e) => {
          e.stopPropagation()
          profileDropdown.classList.toggle('active')
        })

        document.addEventListener('click', () => {
          profileDropdown.classList.remove('active')
        })

        // Fetch user profile
        fetch('/auth/profile')
          .then((response) => response.json())
          .then((data) => {
            // Update profile button
            const profileInitials =
              document.querySelectorAll('.profile-initial')
            profileInitials.forEach((initial) => {
              initial.textContent = data.name.substring(0, 2).toUpperCase()
            })

            // Update profile name
            document
              .getElementById('profileName')
              .querySelector('span').textContent = data.name

            // Show admin button if user is admin
            if (data.is_admin) {
              document.getElementById('adminButton').style.display = 'flex'
            }
          })
          .catch((error) => console.error('Error fetching profile:', error))

        // Check for song ID in URL hash
        const hash = window.location.hash
        const songMatch = hash.match(/song=(\d+)/)
        if (songMatch) {
          const songId = songMatch[1]
          // Fetch the song metadata and add it to the queue
          fetch(`/track/${songId}`)
            .then((response) => response.json())
            .then((metadata) => {
              karaokePlayer.songQueue.push({
                id: songId,
                title: metadata.title,
                artist: metadata.artist,
                thumbnail: `https://e-cdns-images.dzcdn.net/images/cover/${metadata.cover}/250x250-000000-80-0-0.jpg`,
                vocalsUrl: `songs/${songId}/vocals.mp3`,
                musicUrl: `songs/${songId}/no_vocals.mp3`,
                lyricsUrl: `songs/${songId}/lyrics.json`,
                ready: true,
                progress: 100,
                status: '',
              })
              karaokePlayer.renderQueue()
              karaokePlayer.loadSong(0)
            })
            .catch((error) =>
              console.error('Error loading song from URL:', error)
            )
        }
      })

      function debounce(func, wait) {
        let timeout
        return function (...args) {
          clearTimeout(timeout)
          timeout = setTimeout(() => func.apply(this, args), wait)
        }
      }

      // Theme management
      function getTheme() {
        return localStorage.getItem('theme') || 'light'
      }

      function setTheme(theme) {
        localStorage.setItem('theme', theme)
        document.documentElement.setAttribute('data-theme', theme)
      }

      function toggleTheme() {
        const currentTheme = getTheme()
        const newTheme = currentTheme === 'light' ? 'dark' : 'light'
        const darkModeButton = document.getElementById('darkModeButton')
        darkModeButton.innerHTML =
          newTheme === 'light'
            ? `<i class="fas fa-moon"></i>Dark Mode`
            : `<i class="fas fa-sun"></i>Light Mode`
        setTheme(newTheme)
      }

      function toggleMenu() {
        document.body.classList.toggle('collapsed')
      }

      // Initialize theme
      document.addEventListener('DOMContentLoaded', () => {
        setTheme(getTheme())
      })

      function logout() {
        fetch('/auth/logout', {
          method: 'POST',
          credentials: 'include',
        })
          .then((response) => {
            if (response.ok) {
              window.location.href = '/login'
            } else {
              console.error('Logout failed')
            }
          })
          .catch((error) => console.error('Error during logout:', error))
      }
    </script>
  </body>
</html>
